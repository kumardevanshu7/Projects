<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dev MoodMirror ✨</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✨</text></svg>"
    />
    <link rel="shortcut icon" href="logo.png" type="image/x-icon" />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- STYLES START -->
    <style>
      /* --- MODERN CSS RESET --- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        line-height: 1.6;
        font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-main);
        color: var(--text-primary);
        overflow-x: hidden;
        transition: background-color 0.4s ease, color 0.4s ease;
      }
      img,
      picture,
      video,
      canvas,
      svg {
        display: block;
        max-width: 100%;
      }
      input,
      button,
      textarea,
      select {
        font: inherit;
      }
      button {
        cursor: pointer;
        background: none;
        border: none;
        color: inherit;
      }

      /* --- NEW UI - COLOR PALETTE & THEME VARIABLES --- */
      :root {
        --hue-primary: 260; /* Deep Purple */
        --hue-secondary: 340; /* Pink/Magenta */
        --hue-tertiary: 20; /* Orange */
        --hue-accent: 210; /* Blue */
        --hue-neutral: 240; /* Greyish Blue */

        /* Light Theme */
        --bg-main: hsl(var(--hue-neutral), 40%, 98%);
        --bg-card: hsl(0, 0%, 100%);
        --bg-overlay: hsla(var(--hue-neutral), 30%, 10%, 0.5);
        --text-primary: hsl(var(--hue-neutral), 20%, 25%);
        --text-secondary: hsl(var(--hue-neutral), 15%, 50%);
        --text-on-accent: hsl(0, 0%, 100%);

        --accent-purple: hsl(var(--hue-primary), 70%, 65%);
        --accent-purple-darker: hsl(var(--hue-primary), 70%, 55%);
        --accent-pink: hsl(var(--hue-secondary), 80%, 60%);
        --accent-pink-darker: hsl(var(--hue-secondary), 80%, 50%);
        --accent-orange: hsl(var(--hue-tertiary), 90%, 60%);
        --accent-orange-darker: hsl(var(--hue-tertiary), 90%, 50%);
        --accent-blue: hsl(var(--hue-accent), 80%, 60%);
        --accent-blue-darker: hsl(var(--hue-accent), 80%, 50%);

        --border-color: hsl(var(--hue-neutral), 20%, 88%);
        --border-color-light: hsl(var(--hue-neutral), 20%, 94%);
        --shadow-color: hsla(var(--hue-neutral), 20%, 0%, 0.1);
        --shadow-color-hover: hsla(var(--hue-neutral), 25%, 0%, 0.15);
        --shadow-soft: 0 4px 12px -2px var(--shadow-color);
        --shadow-medium: 0 8px 25px -5px var(--shadow-color);

        --border-radius-large: 20px;
        --border-radius-medium: 12px;
        --border-radius-small: 8px;

        --transition-smooth: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        --transition-fast: all 0.2s ease-out;
      }

      body.dark-theme {
        --bg-main: hsl(var(--hue-neutral), 15%, 12%);
        --bg-card: hsl(var(--hue-neutral), 15%, 18%);
        --bg-overlay: hsla(var(--hue-neutral), 10%, 5%, 0.6);
        --text-primary: #f5f5dc; /* Cream white */
        --text-secondary: #e6e6e6; /* Light cream */
        --text-on-accent: hsl(0, 0%, 100%);

        --accent-purple: hsl(var(--hue-primary), 65%, 70%);
        --accent-purple-darker: hsl(var(--hue-primary), 65%, 75%);
        --accent-pink: hsl(var(--hue-secondary), 75%, 65%);
        --accent-pink-darker: hsl(var(--hue-secondary), 75%, 70%);
        --accent-orange: hsl(var(--hue-tertiary), 85%, 65%);
        --accent-orange-darker: hsl(var(--hue-tertiary), 85%, 70%);
        --accent-blue: hsl(var(--hue-accent), 75%, 65%);
        --accent-blue-darker: hsl(var(--hue-accent), 75%, 70%);

        --border-color: hsl(var(--hue-neutral), 15%, 30%);
        --border-color-light: hsl(var(--hue-neutral), 15%, 25%);
        --shadow-color: hsla(0, 0%, 0%, 0.2);
        --shadow-color-hover: hsla(0, 0%, 0%, 0.3);
      }

      /* --- LAYOUT & GENERAL STYLING --- */
      #flowing-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
        opacity: 0.7;
      }

      #app-container {
        max-width: 950px;
        margin: 0 auto;
        padding: 30px 20px;
        position: relative;
        z-index: 1;
      }

      header {
        background: var(--bg-card);
        padding: 15px 25px;
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-soft);
        margin-bottom: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        /* Adjusted gap for streak info */
        gap: 15px;
        border: 1px solid var(--border-color-light);
        transition: var(--transition-smooth);
        position: relative; /* Needed for info button positioning */
      }

      header h1 {
        color: var(--accent-purple);
        margin-bottom: 0;
        font-size: 2em;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }
      header h1 .header-icon {
        font-size: 1.1em;
      }

      nav {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        width: 100%;
      }

      nav button.nav-button {
        background-color: var(--bg-main);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        padding: 8px 18px;
        border-radius: var(--border-radius-small);
        font-size: 0.9em;
        font-weight: 500;
        transition: var(--transition-fast);
        box-shadow: 0 1px 2px hsla(0, 0%, 0%, 0.05);
      }
      nav button.nav-button:hover {
        transform: translateY(-2px);
        background-color: var(--bg-card);
        color: var(--accent-purple);
        border-color: var(--accent-purple);
        box-shadow: 0 4px 8px hsla(var(--hue-primary), 50%, 60%, 0.15);
      }
      nav button.nav-button.active-nav {
        background: linear-gradient(
          135deg,
          var(--accent-purple),
          var(--accent-pink)
        );
        color: var(--text-on-accent);
        border-color: transparent;
        box-shadow: 0 4px 10px -2px hsla(var(--hue-primary), 50%, 60%, 0.4);
        transform: translateY(-1px);
      }
      nav button.nav-button.active-nav:hover {
        box-shadow: 0 6px 15px -3px hsla(var(--hue-primary), 50%, 60%, 0.5);
        filter: brightness(1.1);
      }

      /* Info Button Styling */
      #info-button {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 8px;
        border-radius: 50%;
        background-color: hsla(var(--hue-neutral), 20%, 50%, 0.08);
        color: var(--text-secondary);
        transition: var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }
      #info-button svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
      }
      #info-button:hover {
        background-color: hsla(var(--hue-accent), 60%, 60%, 0.15);
        color: var(--accent-blue);
        transform: scale(1.1);
        box-shadow: 0 2px 6px hsla(var(--hue-accent), 50%, 60%, 0.2);
      }
      body.dark-theme #info-button {
        background-color: hsla(var(--hue-neutral), 15%, 90%, 0.1);
      }
      body.dark-theme #info-button:hover {
        background-color: hsla(var(--hue-accent), 60%, 70%, 0.2);
        color: var(--accent-blue-darker);
        box-shadow: 0 2px 6px hsla(var(--hue-accent), 50%, 70%, 0.2);
      }

      main {
        position: relative;
        min-height: 400px;
      }

      .page {
        background-color: transparent;
        padding: 0;
        border-radius: 0;
        box-shadow: none;
        border: none;
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease-out, visibility 0.5s;
      }
      .page.active {
        opacity: 1;
        visibility: visible;
        position: relative;
      }

      .page-title {
        color: var(--accent-purple);
        text-align: center;
        margin-bottom: 35px;
        font-size: 1.8em;
        font-weight: 600;
      }
      .sub-section-title {
        /* New style for section titles within pages */
        color: var(--accent-blue);
        text-align: center;
        margin-top: 40px;
        margin-bottom: 25px;
        font-size: 1.5em;
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
      }
      #mood-slider-page .sub-section-title:first-of-type {
        margin-top: 0; /* No top margin for the first sub-section title */
      }

      .card-base {
        background-color: var(--bg-card);
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-color-light);
        transition: var(--transition-smooth);
        overflow: hidden; /* Keep for general card base */
      }
      .card-base:hover {
        transform: translateY(-4px) scale(1.015);
        box-shadow: var(--shadow-medium);
      }

      #mood-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 25px;
        justify-items: center;
      }

      .mood-button {
        background-color: var(--bg-card);
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-color-light);
        padding: 20px 15px;
        text-align: center;
        transition: var(--transition-smooth);
        width: 100%;
        max-width: 130px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        aspect-ratio: 1 / 1;
      }
      .mood-button:hover {
        transform: translateY(-6px) scale(1.06);
        box-shadow: var(--shadow-medium);
        border-color: var(--accent-purple);
        background: linear-gradient(
          160deg,
          var(--bg-card),
          hsl(var(--hue-primary), 60%, 95%)
        );
      }
      body.dark-theme .mood-button:hover {
        background: linear-gradient(
          160deg,
          var(--bg-card),
          hsl(var(--hue-primary), 20%, 25%)
        );
        border-color: var(--accent-purple);
      }
      .mood-emoji {
        font-size: 3em;
        display: block;
        margin-bottom: 10px;
        transition: transform 0.3s ease-in-out;
      }
      .mood-button:hover .mood-emoji {
        transform: scale(1.2) rotate(-8deg);
      }
      .mood-text {
        font-size: 0.95em;
        color: var(--text-secondary);
        font-weight: 500;
      }
      body.dark-theme .mood-text {
        color: var(--text-secondary);
      }

      .modal {
        background-color: hsla(var(--hue-neutral), 30%, 10%, 0.5);
        backdrop-filter: blur(8px) saturate(120%);
        -webkit-backdrop-filter: blur(8px) saturate(120%);
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal-content-base {
        background-color: var(--bg-card);
        margin: auto;
        padding: 35px 40px;
        border-radius: var(--border-radius-large);
        width: 90%;
        box-shadow: 0 15px 50px hsla(var(--hue-neutral), 25%, 10%, 0.3);
        border: 1px solid var(--border-color);
        transform: scale(0.8);
        opacity: 0;
        position: relative;
      }
      body.dark-theme .modal-content-base {
        box-shadow: 0 15px 50px hsla(0, 0%, 0%, 0.4);
        border-color: var(--border-color);
      }

      #mood-reason-modal .modal-content {
        max-width: 580px;
        text-align: center;
      }
      #mood-reason-modal .modal-content h3 {
        color: var(--accent-purple);
        margin-bottom: 25px;
        font-size: 1.7em;
        font-weight: 600;
      }
      #mood-reason-modal .modal-content textarea {
        width: 100%;
        padding: 15px 18px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-small);
        min-height: 100px;
        background-color: var(--bg-main);
        transition: var(--transition-smooth);
        font-size: 1em;
      }
      #mood-reason-modal .modal-content textarea:focus {
        border-color: var(--accent-purple);
        box-shadow: 0 0 0 3px hsla(var(--hue-primary), 70%, 65%, 0.3);
        outline: none;
        background-color: var(--bg-card);
      }
      body.dark-theme #mood-reason-modal .modal-content textarea {
        background-color: var(--bg-main);
      }
      body.dark-theme #mood-reason-modal .modal-content textarea:focus {
        background-color: hsl(var(--hue-neutral), 15%, 20%);
        box-shadow: 0 0 0 3px hsla(var(--hue-primary), 65%, 70%, 0.3);
      }
      #mood-reason-modal .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 18px;
        margin-top: 20px;
      }

      .modal-button-base {
        color: var(--text-on-accent);
        padding: 12px 30px;
        border-radius: 50px;
        font-size: 1em;
        font-weight: 600;
        transition: var(--transition-smooth), transform 0.15s ease;
        box-shadow: 0 4px 10px -2px hsla(0, 0%, 0%, 0.15);
      }
      .modal-button-base:hover {
        transform: translateY(-3px) scale(1.03);
        filter: brightness(1.1);
        box-shadow: 0 6px 15px -3px hsla(0, 0%, 0%, 0.2);
      }
      .modal-button-base:active {
        transform: translateY(0px) scale(0.98);
        filter: brightness(0.95);
      }
      #mood-reason-modal #save-mood-button {
        background: linear-gradient(
          135deg,
          var(--accent-purple),
          var(--accent-pink)
        );
      }
      #mood-reason-modal .close-button {
        background: hsl(var(--hue-neutral), 15%, 75%);
        color: hsl(var(--hue-neutral), 15%, 30%);
        box-shadow: 0 3px 6px hsla(0, 0%, 0%, 0.1);
      }
      body.dark-theme #mood-reason-modal .close-button {
        background: hsl(var(--hue-neutral), 15%, 35%);
        color: hsl(var(--hue-neutral), 15%, 85%);
        box-shadow: 0 3px 6px hsla(0, 0%, 0%, 0.2);
      }
      #mood-reason-modal .close-button:hover {
        filter: brightness(1.05);
        box-shadow: 0 5px 10px -2px hsla(0, 0%, 0%, 0.15);
      }
      body.dark-theme #mood-reason-modal .close-button:hover {
        box-shadow: 0 5px 10px -2px hsla(0, 0%, 0%, 0.25);
      }

      #mood-reason-modal #modal-quote-display {
        margin-top: 25px;
        cursor: default;
        background-color: var(--bg-main);
        border-left: 5px solid var(--accent-orange);
        padding: 18px 22px;
        border-radius: var(--border-radius-small);
        box-shadow: inset 0 1px 3px hsla(0, 0%, 0%, 0.05);
        text-align: left;
      }
      body.dark-theme #mood-reason-modal #modal-quote-display {
        background-color: hsl(var(--hue-neutral), 15%, 20%);
        border-left-color: var(--accent-orange-darker);
        box-shadow: inset 0 1px 3px hsla(0, 0%, 0%, 0.15);
      }
      #mood-reason-modal #modal-quote-display p {
        font-size: 0.95em;
      }
      #mood-reason-modal #modal-quote-display .quote-source {
        color: var(--accent-orange);
      }
      body.dark-theme #mood-reason-modal #modal-quote-display .quote-source {
        color: var(--accent-orange-darker);
      }

      /* --- Quote Card (General) --- */
      .quote-card {
        background-color: var(--bg-card);
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-color-light);
        transition: var(--transition-smooth);
        padding: 22px 28px;
        margin-bottom: 20px; /* Adjusted from margin: 20px 0 */
        position: relative;
        overflow: visible; /* Changed from hidden to allow overlap */
        border-left: 5px solid var(--accent-orange);
      }
      #quote-slider-results .quote-card:hover, /* Keep general hover for card body */
      #history-list .history-item .quote-card:hover,
      #liked-quotes-explorer-list .quote-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: var(--shadow-medium);
        border-left-color: var(--accent-pink);
      }
      body.dark-theme .quote-card {
        border-left-color: var(--accent-orange-darker);
      }
      body.dark-theme #quote-slider-results .quote-card:hover,
      body.dark-theme #history-list .history-item .quote-card:hover,
      body.dark-theme #liked-quotes-explorer-list .quote-card:hover {
        border-left-color: var(--accent-pink-darker);
      }
      .quote-card p.quote-text {
        font-style: normal;
        font-size: 1.1em;
        margin-bottom: 18px;
        color: var(--text-primary);
        line-height: 1.55;
      }
      .quote-card p.quote-source {
        font-size: 0.9em;
        color: var(--accent-orange);
        text-align: right;
        font-weight: 500;
      }
      body.dark-theme .quote-card p.quote-source {
        color: var(--accent-orange-darker);
      }
      .quote-card .quote-details {
        font-size: 0.88em;
        color: var(--text-secondary);
        margin-top: 18px;
        border-top: 1px solid var(--border-color);
        padding-top: 18px;
        line-height: 1.65;
      }
      .quote-card .quote-details span {
        display: block;
        margin-bottom: 6px;
      }
      .quote-card .quote-details strong {
        color: var(--text-primary);
        font-weight: 600;
        margin-right: 6px;
      }

      /* --- Quote View Modal (Specific) --- */
      #quote-view-modal .quote-view-content {
        max-width: 550px;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: 85vh;
      }
      #quote-view-details {
        padding: 45px 40px 35px 40px;
        position: relative;
        flex-grow: 1;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--accent-purple) transparent;
      }
      #quote-view-details::-webkit-scrollbar {
        width: 6px;
      }
      #quote-view-details::-webkit-scrollbar-thumb {
        background-color: var(--accent-purple);
        border-radius: 3px;
      }
      #quote-view-details::-webkit-scrollbar-track {
        background: transparent;
      }
      #quote-view-details::before {
        content: "";
        position: absolute;
        left: 20px;
        top: 45px;
        bottom: 35px;
        width: 5px;
        background: linear-gradient(
          180deg,
          var(--accent-orange),
          var(--accent-pink)
        );
        border-radius: 3px;
        opacity: 0.9;
      }
      .quote-view-quote {
        font-size: 1.8em;
        font-weight: 500;
        line-height: 1.4;
        margin-bottom: 25px;
        margin-left: 20px;
        color: var(--text-primary);
        position: relative;
      }
      .quote-view-quote::before {
        content: "“";
        position: absolute;
        left: -8px;
        top: -12px;
        font-size: 3em;
        color: var(--accent-purple);
        opacity: 0.15;
        line-height: 1;
      }
      .quote-view-source {
        display: block;
        text-align: right;
        font-size: 1em;
        font-weight: 500;
        color: var(--accent-purple);
        margin-bottom: 30px;
        margin-right: 10px;
      }
      .quote-view-separator {
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          var(--border-color),
          transparent
        );
        border: none;
        margin: 0 auto 30px auto;
        width: 70%;
      }
      .quote-view-meta {
        margin-left: 20px;
        font-size: 0.92em;
        line-height: 1.75;
        color: var(--text-secondary);
      }
      .quote-view-meta-item {
        margin-bottom: 10px;
      }
      .quote-view-meta strong {
        font-weight: 600;
        color: var(--text-primary);
        margin-right: 8px;
        display: inline-block;
        min-width: 90px;
      }
      .close-quote-view {
        position: absolute;
        top: 18px;
        right: 18px;
        background: hsla(var(--hue-neutral), 20%, 50%, 0.1);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6em;
        line-height: 1;
        font-weight: 300;
        color: var(--text-secondary);
        transition: var(--transition-fast);
        z-index: 1002;
      }
      body.dark-theme .close-quote-view {
        background: hsla(var(--hue-neutral), 15%, 90%, 0.1);
      }
      .close-quote-view:hover {
        color: var(--accent-pink);
        background: hsla(var(--hue-secondary), 70%, 60%, 0.15);
        transform: scale(1.15) rotate(90deg);
      }

      /* --- Info Modal Specific --- */
      #info-modal .modal-content {
        max-width: 650px;
        text-align: left;
      }
      .info-modal-title {
        color: var(--accent-blue);
        font-size: 1.6em;
        font-weight: 600;
        margin-bottom: 25px;
        text-align: center;
      }
      .info-modal-content p {
        margin-bottom: 15px;
        color: var(--text-secondary);
        line-height: 1.7;
      }
      .info-modal-content strong {
        color: var(--text-primary);
        font-weight: 600;
      }
      /* Style list inside info modal */
      .info-modal-content ul {
        list-style: disc;
        margin-left: 25px;
        margin-bottom: 15px;
        color: var(--text-secondary);
      }
      .info-modal-content li {
        margin-bottom: 8px;
      }
      .info-modal-credit {
        margin-top: 30px;
        text-align: center;
        font-size: 0.9em;
        color: var(--text-secondary);
        opacity: 0.8;
        border-top: 1px solid var(--border-color-light);
        padding-top: 20px;
      }
      #close-info-modal-button {
        position: absolute;
        top: 18px;
        right: 18px;
        background: hsla(var(--hue-neutral), 20%, 50%, 0.1);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6em;
        line-height: 1;
        font-weight: 300;
        color: var(--text-secondary);
        transition: var(--transition-fast);
        z-index: 1002;
      }
      body.dark-theme #close-info-modal-button {
        background: hsla(var(--hue-neutral), 15%, 90%, 0.1);
      }
      #close-info-modal-button:hover {
        color: var(--accent-pink);
        background: hsla(var(--hue-secondary), 70%, 60%, 0.15);
        transform: scale(1.15) rotate(90deg);
      }

      /* --- Feature 3: Mood Analytics --- */
      #analytics-page .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
      }
      #analytics-page .chart-container {
        background-color: var(--bg-card);
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-color-light);
        transition: var(--transition-smooth);
        padding: 25px;
        height: 380px;
        display: flex;
        flex-direction: column;
      }
      #analytics-page .chart-container:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-medium);
      }
      #analytics-page h3 {
        color: var(--accent-orange);
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        font-size: 1.2em;
      }
      #analytics-page .chart-wrapper {
        flex-grow: 1;
        position: relative;
        width: 100%;
      }
      #analytics-page canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: block;
        box-sizing: border-box;
      }
      #reason-snippets-container {
        margin-top: 40px;
      }
      .reason-snippet {
        background-color: hsl(var(--hue-tertiary), 90%, 96%);
        border-radius: var(--border-radius-small);
        box-shadow: 0 2px 5px hsla(var(--hue-tertiary), 30%, 50%, 0.08);
        border: 1px solid hsl(var(--hue-tertiary), 70%, 90%);
        transition: var(--transition-smooth);
        padding: 15px 20px;
        margin-bottom: 15px;
        font-size: 0.95em;
        color: hsl(var(--hue-tertiary), 60%, 35%);
      }
      body.dark-theme .reason-snippet {
        background-color: hsl(var(--hue-tertiary), 30%, 25%);
        border-color: hsl(var(--hue-tertiary), 20%, 35%);
        color: hsl(var(--hue-tertiary), 70%, 80%);
        box-shadow: 0 2px 5px hsla(0, 0%, 0%, 0.15);
      }
      .reason-snippet:hover {
        transform: translateX(6px) scale(1.01);
        box-shadow: 0 5px 12px hsla(var(--hue-tertiary), 40%, 50%, 0.15);
        border-color: var(--accent-orange);
      }
      body.dark-theme .reason-snippet:hover {
        box-shadow: 0 5px 12px hsla(0, 0%, 0%, 0.2);
        border-color: var(--accent-orange-darker);
      }
      .reason-snippet .mood-emoji-small {
        font-size: 1.4em;
        margin-right: 10px;
        vertical-align: middle;
      }
      .reason-snippet .reason-date {
        font-size: 0.8em;
        color: hsl(var(--hue-tertiary), 40%, 50%);
        display: block;
        margin-top: 6px;
        opacity: 0.8;
      }
      body.dark-theme .reason-snippet .reason-date {
        color: hsl(var(--hue-tertiary), 30%, 60%);
      }

      /* --- Feature 4: Mood Slider Page (Explorer) --- */
      #mood-filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 30px;
        padding: 18px 22px;
        background-color: var(--bg-card);
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-color-light);
      }
      #mood-filter-container label {
        font-weight: 500;
        color: var(--text-secondary);
        margin-right: 5px;
      }
      .filter-control {
        padding: 9px 16px;
        border-radius: var(--border-radius-small);
        border: 1px solid var(--border-color);
        background-color: var(--bg-main);
        color: var(--text-primary);
        cursor: pointer;
        transition: var(--transition-smooth);
        box-shadow: 0 1px 2px hsla(0, 0%, 0%, 0.03);
        min-width: 140px;
        text-align: center;
      }
      body.dark-theme .filter-control {
        background-color: hsl(var(--hue-neutral), 15%, 25%);
        border-color: hsl(var(--hue-neutral), 15%, 35%);
      }
      .filter-control:hover {
        border-color: var(--accent-blue);
        box-shadow: 0 3px 6px hsla(var(--hue-accent), 50%, 60%, 0.1);
        background-color: var(--bg-card);
      }
      body.dark-theme .filter-control:hover {
        background-color: hsl(var(--hue-neutral), 15%, 28%);
        border-color: var(--accent-blue-darker);
      }
      #mood-filter-select {
        /* Styling handled by .filter-select */
      }
      #quote-mode-toggle {
        font-weight: 500;
      }
      #theme-toggle {
        min-width: 130px;
      }
      #quote-slider-results,
      #liked-quotes-explorer-list {
        /* Apply grid to both lists */
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-top: 20px; /* Add some space above general results if liked quotes are present */
      }
      #liked-quotes-explorer-list {
        margin-bottom: 40px; /* Space below liked quotes if any */
      }

      /* Style for the new Like button on Explorer page cards - IMPROVED */
      .like-btn {
        position: absolute;
        top: -10px; /* Overlap a bit */
        right: -10px; /* Overlap a bit */
        font-size: 1.6em; /* Slightly smaller */
        color: hsl(var(--hue-neutral), 15%, 70%); /* Default subtle color */
        background-color: var(--bg-card); /* Match card background */
        border-radius: 50%;
        width: 38px; /* Fixed size */
        height: 38px; /* Fixed size */
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px hsla(0, 0%, 0%, 0.1);
        transition: color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        z-index: 5;
        opacity: 0.85;
        border: 1px solid var(--border-color-light);
      }
      body.dark-theme .like-btn {
        color: hsl(var(--hue-neutral), 15%, 55%);
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 5px hsla(0, 0%, 0%, 0.2);
      }
      .like-btn:hover {
        transform: scale(1.15);
        opacity: 1;
        color: var(--accent-pink); /* Pink on hover */
        box-shadow: 0 3px 8px hsla(var(--hue-secondary), 50%, 50%, 0.2);
      }
      .like-btn.liked {
        color: var(--accent-pink); /* Solid pink when liked */
        opacity: 1;
        transform: scale(1.05); /* Slight pop when liked */
      }
      body.dark-theme .like-btn.liked {
        color: var(--accent-pink-darker);
      }
      .like-btn.liked:hover {
        /* Keep pink on hover if liked */
        color: var(--accent-pink-darker);
        filter: brightness(1.1);
      }

      /* --- Feature 5: Quote History --- */
      #history-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 30px;
        padding: 18px 22px;
        background-color: var(--bg-card);
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-color-light);
      }
      #history-controls input,
      #history-controls select {
        flex-grow: 1;
      }
      #history-controls input:focus,
      #history-controls select:focus {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px hsla(var(--hue-accent), 80%, 60%, 0.25);
        outline: none;
      }
      body.dark-theme #history-controls input:focus,
      body.dark-theme #history-controls select:focus {
        box-shadow: 0 0 0 3px hsla(var(--hue-accent), 75%, 65%, 0.25);
      }
      #history-controls button#clear-history-filters {
        background-color: var(--accent-orange);
        color: var(--text-on-accent);
        border-color: transparent;
        font-weight: 500;
        box-shadow: 0 3px 8px -1px hsla(var(--hue-tertiary), 60%, 50%, 0.3);
      }
      body.dark-theme #history-controls button#clear-history-filters {
        background-color: var(--accent-orange-darker);
        box-shadow: 0 3px 8px -1px hsla(var(--hue-tertiary), 40%, 40%, 0.4);
      }
      #history-controls button#clear-history-filters:hover {
        background-color: var(--accent-orange-darker);
        box-shadow: 0 5px 12px -2px hsla(var(--hue-tertiary), 60%, 50%, 0.4);
        filter: brightness(1.1);
      }
      body.dark-theme #history-controls button#clear-history-filters:hover {
        background-color: var(--accent-orange);
        box-shadow: 0 5px 12px -2px hsla(var(--hue-tertiary), 40%, 40%, 0.5);
      }

      #history-list .history-item {
        background-color: var(--bg-card);
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-color-light);
        transition: var(--transition-smooth);
        padding: 25px 30px;
        margin-bottom: 25px;
        position: relative;
      }
      #history-list .history-item:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-medium);
      }
      .history-item h4 {
        color: var(--accent-blue);
        margin-bottom: 6px;
        font-size: 1.15em;
        font-weight: 600;
        display: flex;
        align-items: center;
      }
      .history-item .item-mood {
        font-size: 1.6em;
        margin-right: 12px;
        line-height: 1;
      }
      .history-item .item-date {
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-bottom: 15px;
        opacity: 0.8;
      }
      .history-item .item-reason {
        font-style: normal;
        color: var(--text-secondary);
        margin: 15px 0 20px 0;
        padding: 12px 18px;
        border-left: 4px solid var(--accent-orange);
        background-color: var(--bg-main);
        border-radius: 0 var(--border-radius-small) var(--border-radius-small) 0;
        font-size: 0.95em;
      }
      body.dark-theme .history-item .item-reason {
        border-left-color: var(--accent-orange-darker);
        background-color: hsl(var(--hue-neutral), 15%, 20%);
      }
      #history-list .history-item .quote-card {
        margin: 20px 0 0 0;
      }

      /* Enhanced History Item Styles */
      .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .history-item-header h4 {
        display: flex;
        align-items: center;
        margin: 0;
        font-size: 1.1rem;
      }

      .item-mood-emoji {
        font-size: 1.5rem;
        margin-right: 0.5rem;
      }

      .item-mood-name {
        font-weight: 600;
        color: var(--text-primary);
      }

      .mood-tag {
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 12px;
        color: white;
        margin-left: 8px;
      }

      .item-reason-container {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid var(--accent-blue);
      }

      .item-reason-container .item-reason {
        margin: 0;
        color: var(--text-primary);
        line-height: 1.5;
        background: none;
        border: none;
        padding: 0;
      }

      @media (max-width: 768px) {
        .history-item-header {
          flex-direction: column;
          gap: 0.5rem;
        }

        .mood-tag {
          margin-left: 0 !important;
          margin-top: 0.25rem;
        }
      }

      /* Loading spinner animation */
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Enhanced Background Floating Emojis */
      .floating-emoji-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
        overflow: hidden;
      }

      .floating-emoji {
        position: absolute;
        font-size: 2rem;
        opacity: 0.1;
        filter: blur(1px);
        animation: floatEmoji 15s infinite linear;
        user-select: none;
        pointer-events: none;
      }

      .floating-emoji.large {
        font-size: 3rem;
        opacity: 0.08;
        filter: blur(2px);
        animation-duration: 20s;
      }

      .floating-emoji.small {
        font-size: 1.5rem;
        opacity: 0.12;
        filter: blur(0.5px);
        animation-duration: 12s;
      }

      @keyframes floatEmoji {
        0% {
          transform: translateY(100vh) rotate(0deg);
        }
        100% {
          transform: translateY(-100px) rotate(360deg);
        }
      }

      /* Blurry background overlay */
      .bg-blur-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(139, 69, 19, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(75, 0, 130, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(255, 20, 147, 0.02) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: -2;
      }

      /* Mood Heatmap Styles */
      .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(53, 1fr);
        gap: 3px;
        max-width: 100%;
      }

      .heatmap-day {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        background: var(--bg-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .heatmap-day:hover {
        transform: scale(1.2);
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .heatmap-day.level-1 {
        background: #c6e48b;
      }
      .heatmap-day.level-2 {
        background: #7bc96f;
      }
      .heatmap-day.level-3 {
        background: #239a3b;
      }
      .heatmap-day.level-4 {
        background: #196127;
      }

      .heatmap-tooltip {
        position: absolute;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.8rem;
        color: var(--text-primary);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        pointer-events: none;
        white-space: nowrap;
      }

      .heatmap-months {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 10px;
        margin-bottom: 8px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-align: center;
      }

      .heatmap-days {
        display: grid;
        grid-template-rows: repeat(7, 1fr);
        gap: 3px;
        margin-right: 8px;
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-align: right;
        padding-right: 8px;
      }

      .heatmap-wrapper {
        display: flex;
        align-items: flex-start;
      }

      /* Dark theme adjustments */
      body.dark-theme .heatmap-tooltip {
        background: var(--bg-card);
        border-color: var(--border-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      /* Mood Calendar Styles */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        max-width: 100%;
      }

      .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-align: center;
      }

      .calendar-day {
        aspect-ratio: 1;
        min-height: 40px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-main);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 4px;
        overflow: hidden;
      }

      .calendar-day:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 5;
      }

      .calendar-day.other-month {
        opacity: 0.3;
        background: var(--bg-secondary);
      }

      .calendar-day.today {
        border: 2px solid var(--accent-blue);
        background: var(--accent-blue);
        color: white;
      }

      .calendar-day.selected {
        border: 2px solid var(--accent-orange);
        background: var(--accent-orange);
        color: white;
      }

      .calendar-day.has-moods {
        background: linear-gradient(
          135deg,
          var(--bg-main) 0%,
          var(--accent-purple) 100%
        );
        border-color: var(--accent-purple);
      }

      .calendar-day-number {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .calendar-day-moods {
        display: flex;
        flex-wrap: wrap;
        gap: 1px;
        justify-content: center;
        align-items: center;
        flex: 1;
        width: 100%;
      }

      .calendar-mood-emoji {
        font-size: 0.7rem;
        line-height: 1;
      }

      .calendar-mood-count {
        position: absolute;
        top: 2px;
        right: 2px;
        background: var(--accent-pink);
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        font-weight: 600;
      }

      /* Week view styles */
      .week-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        max-width: 100%;
      }

      .week-day {
        min-height: 80px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-main);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        padding: 8px;
      }

      .week-day:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .week-day.today {
        border: 2px solid var(--accent-blue);
        background: linear-gradient(
          135deg,
          var(--bg-main) 0%,
          var(--accent-blue) 100%
        );
      }

      .week-day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .week-day-moods {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
      }

      .week-mood-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 6px;
        background: var(--bg-secondary);
        border-radius: 4px;
        font-size: 0.8rem;
      }

      /* View toggle button styles */
      .view-toggle-btn.active {
        background: var(--accent-blue) !important;
        color: white !important;
      }

      .view-toggle-btn:not(.active):hover {
        background: var(--bg-main) !important;
        color: var(--text-primary) !important;
      }

      /* Calendar navigation hover effects */
      #calendar-prev:hover,
      #calendar-next:hover {
        background: var(--accent-blue) !important;
        color: white !important;
      }

      #calendar-today:hover {
        background: var(--accent-pink) !important;
      }

      /* Favorite button styles (will no longer be used on History card, but kept as per "don't change anything else") */
      .favorite-btn {
        position: absolute;
        top: 18px;
        right: 18px;
        font-size: 1.9em;
        color: hsl(var(--hue-neutral), 15%, 80%);
        transition: color 0.3s ease, transform 0.2s ease;
        z-index: 5;
        opacity: 0.7;
      }
      body.dark-theme .favorite-btn {
        color: hsl(var(--hue-neutral), 15%, 45%);
      }
      .favorite-btn:hover {
        transform: scale(1.2);
        opacity: 1;
      }
      .favorite-btn.favorited {
        color: hsl(var(--hue-secondary), 80%, 60%);
        opacity: 1;
      }
      body.dark-theme .favorite-btn.favorited {
        color: hsl(var(--hue-secondary), 75%, 65%);
      }

      /* --- UTILITY --- */
      .text-center {
        text-align: center;
      }
      .mb-1 {
        margin-bottom: 0.5rem;
      }
      .mb-2 {
        margin-bottom: 1rem;
      }
      .mb-3 {
        margin-bottom: 1.5rem;
      }
      .empty-list-message {
        /* Style for empty state messages */
        color: var(--text-secondary);
        text-align: center;
        padding: 20px;
        font-style: italic;
      }

      /* --- RESPONSIVE --- */
      @media (max-width: 768px) {
        header {
          position: relative;
        } /* Ensure stacking context for info button */
        #info-button {
          top: 10px;
          right: 10px;
          padding: 6px;
        }
        #info-button svg {
          width: 18px;
          height: 18px;
        }
        header h1 {
          font-size: 1.8em;
        }
        nav button.nav-button {
          padding: 7px 15px;
          font-size: 0.85em;
        }
        .page-title {
          font-size: 1.6em;
        }
        .sub-section-title {
          font-size: 1.3em;
        }
        .mood-emoji {
          font-size: 2.6em;
        }
        #mood-reason-modal .modal-content {
          max-width: 92%;
          padding: 30px;
        }
        .quote-view-content {
          max-width: 92%;
        }
        #quote-view-details {
          padding: 40px 30px 30px 30px;
        }
        #quote-view-details::before {
          left: 15px;
        }
        #mood-selection-grid {
          gap: 20px;
          grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        }
        #analytics-page .chart-grid {
          grid-template-columns: 1fr;
        }
        #analytics-page .chart-container {
          height: 320px;
        }
        #mood-filter-container,
        #history-controls {
          flex-direction: column;
          align-items: stretch;
        }
        .like-btn {
          top: -8px;
          right: -8px;
          width: 34px;
          height: 34px;
          font-size: 1.4em;
        }

        /* Mobile User Info Fix */
        #user-info {
          position: static !important;
          margin: 1rem 0;
          text-align: center;
          background: var(--bg-secondary);
          padding: 0.75rem;
          border-radius: 12px;
          border: 1px solid var(--border-color);
          width: 100%;
          box-sizing: border-box;
        }

        #user-info span {
          display: block;
          margin-bottom: 0.5rem;
          font-size: 0.9rem;
          color: var(--text-primary);
        }

        #user-info button {
          margin-left: 0 !important;
          font-size: 0.8rem;
          padding: 6px 12px;
          width: auto;
        }

        /* Profile page mobile fixes */
        .profile-container {
          padding: 0 !important;
        }

        .profile-field {
          margin-bottom: 1.5rem !important;
        }

        .profile-field > div {
          flex-direction: column !important;
          gap: 0.75rem !important;
        }

        .profile-field input {
          width: 100% !important;
          box-sizing: border-box;
        }

        .profile-field button {
          width: 100% !important;
          margin-left: 0 !important;
        }

        /* Heatmap mobile optimization */
        .heatmap-grid {
          grid-template-columns: repeat(53, 8px);
          gap: 2px;
        }

        .heatmap-day {
          width: 8px;
          height: 8px;
        }

        .heatmap-months {
          font-size: 0.65rem;
          gap: 5px;
        }

        .heatmap-days {
          font-size: 0.6rem;
          gap: 2px;
        }

        #mood-heatmap-container {
          padding: 0.5rem 0 !important;
        }

        /* Calendar mobile optimization */
        .calendar-day {
          min-height: 35px;
          padding: 2px;
        }

        .calendar-day-number {
          font-size: 0.7rem;
        }

        .calendar-mood-emoji {
          font-size: 0.6rem;
        }

        .calendar-mood-count {
          width: 14px;
          height: 14px;
          font-size: 0.55rem;
        }

        .week-day {
          min-height: 60px;
          padding: 6px;
        }

        .week-day-header {
          font-size: 0.8rem;
        }

        .week-mood-item {
          font-size: 0.7rem;
          padding: 3px 5px;
        }

        .calendar-view-toggle {
          order: 2;
        }

        .calendar-navigation {
          order: 1;
          width: 100%;
          justify-content: center;
        }

        #calendar-current-period {
          min-width: 100px;
          font-size: 0.8rem;
        }
      }

      @media (max-width: 480px) {
        #app-container {
          padding: 20px 15px;
        }
        header {
          padding: 15px;
          gap: 15px;
          margin-bottom: 30px;
        }
        header h1 {
          font-size: 1.6em;
        }
        nav {
          gap: 8px;
        }
        nav button.nav-button {
          padding: 6px 12px;
          font-size: 0.8em;
        }
        #mood-selection-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 15px;
        } /* Force 2 columns */
        .mood-button {
          padding: 15px 10px;
          max-width: none;
        }
        .mood-emoji {
          font-size: 2.5em;
        }
        .page-title {
          font-size: 1.4em;
          margin-bottom: 25px;
        }
        .sub-section-title {
          font-size: 1.2em;
        }
        .modal-content-base {
          padding: 25px;
        }
        #mood-reason-modal .modal-content {
          max-width: 95%;
        }
        .quote-view-content {
          max-width: 95%;
        }
        #quote-view-details {
          padding: 35px 25px 25px 25px;
        }
        #quote-view-details::before {
          left: 10px;
        }
        .quote-view-quote {
          font-size: 1.5em;
          margin-left: 10px;
        }
        .quote-view-meta {
          margin-left: 10px;
          font-size: 0.9em;
        }
        #mood-reason-modal .modal-content h3 {
          font-size: 1.4em;
        }
        #mood-reason-modal .modal-buttons {
          flex-direction: column;
          gap: 12px;
        }
        .modal-button-base {
          width: 100%;
        }
        #quote-slider-results,
        #liked-quotes-explorer-list {
          grid-template-columns: 1fr;
          gap: 25px;
        }
        .quote-card {
          padding: 20px;
        }
        #history-list .history-item {
          padding: 20px;
        }
        .like-btn {
          top: -5px;
          right: -5px;
          width: 32px;
          height: 32px;
          font-size: 1.3em;
        }
      }
    </style>
    <!-- STYLES END -->
  </head>
  <body>
    <!-- Enhanced Background -->
    <div class="bg-blur-overlay"></div>
    <div class="floating-emoji-bg" id="floating-emoji-bg"></div>
    <canvas id="flowing-background"></canvas>

    <div id="app-container">
      <header>
        <!-- Info Button Added Here -->
        <button id="info-button" title="About MoodMirror">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 20 20"
            fill="currentColor"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
        <!-- End Info Button -->

        <h1>
          <span class="header-icon"><i class="fas fa-sparkles"></i></span>
          DevMoodMirror
        </h1>
        <nav>
          <button data-page="home" class="nav-button active-nav">
            <i class="fas fa-home"></i> Home
          </button>
          <button data-page="analytics" class="nav-button">
            <i class="fas fa-chart-line"></i> Analytics
          </button>
          <button data-page="mood-slider" class="nav-button">
            <i class="fas fa-compass"></i> Explorer
          </button>
          <button data-page="public-mood" class="nav-button">
            <i class="fas fa-users"></i> Public Moods
          </button>
          <button data-page="history" class="nav-button">
            <i class="fas fa-history"></i> History
          </button>
          <button data-page="profile" class="nav-button">
            <i class="fas fa-user"></i> Profile
          </button>
        </nav>
        <!-- STREAK DISPLAY START -->
        <div
          id="streak-info"
          style="
            text-align: center;
            font-size: 0.9em;
            color: var(--text-secondary);
            width: 100%;
          "
        >
          Current Streak:
          <strong
            id="current-streak-value"
            style="color: var(--accent-orange); font-weight: bold"
            >0</strong
          >
          <i class="fas fa-fire"></i> &nbsp;&nbsp;|&nbsp;&nbsp; Highest Streak:
          <span
            id="highest-streak-value"
            style="color: var(--accent-blue); font-weight: bold"
            >0</span
          >
          <i class="fas fa-trophy"></i>
        </div>
        <!-- STREAK DISPLAY END -->
      </header>

      <main>
        <!-- Home Page -->
        <section id="home-page" class="page active">
          <h2 class="page-title">
            <i class="fas fa-smile"></i> How are you feeling right now?
          </h2>
          <div id="mood-selection-grid"></div>
        </section>

        <!-- Analytics Page -->
        <section id="analytics-page" class="page">
          <h2 class="page-title">
            <i class="fas fa-chart-line"></i> Your Mood Insights
          </h2>

          <!-- Quick Stats Cards -->
          <div
            class="analytics-stats-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 1.5rem;
              margin-bottom: 2rem;
            "
          >
            <div
              class="stat-card card-base"
              style="text-align: center; padding: 1.5rem"
            >
              <div
                class="stat-icon"
                style="font-size: 2.5rem; margin-bottom: 0.5rem"
              >
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="stat-content">
                <div
                  class="stat-number"
                  id="total-entries-stat"
                  style="
                    font-size: 2rem;
                    font-weight: 700;
                    color: var(--accent-blue);
                    margin-bottom: 0.25rem;
                  "
                >
                  0
                </div>
                <div
                  class="stat-label"
                  style="color: var(--text-secondary); font-size: 0.9rem"
                >
                  Total Entries
                </div>
              </div>
            </div>
            <div
              class="stat-card card-base"
              style="text-align: center; padding: 1.5rem"
            >
              <div
                class="stat-icon"
                style="font-size: 2.5rem; margin-bottom: 0.5rem"
              >
                <i class="fas fa-fire"></i>
              </div>
              <div class="stat-content">
                <div
                  class="stat-number"
                  id="current-streak-stat"
                  style="
                    font-size: 2rem;
                    font-weight: 700;
                    color: var(--accent-orange);
                    margin-bottom: 0.25rem;
                  "
                >
                  0
                </div>
                <div
                  class="stat-label"
                  style="color: var(--text-secondary); font-size: 0.9rem"
                >
                  Current Streak
                </div>
              </div>
            </div>
            <div
              class="stat-card card-base"
              style="text-align: center; padding: 1.5rem"
            >
              <div
                class="stat-icon"
                style="font-size: 2.5rem; margin-bottom: 0.5rem"
              >
                <i class="fas fa-trophy"></i>
              </div>
              <div class="stat-content">
                <div
                  class="stat-number"
                  id="best-streak-stat"
                  style="
                    font-size: 2rem;
                    font-weight: 700;
                    color: var(--accent-purple);
                    margin-bottom: 0.25rem;
                  "
                >
                  0
                </div>
                <div
                  class="stat-label"
                  style="color: var(--text-secondary); font-size: 0.9rem"
                >
                  Best Streak
                </div>
              </div>
            </div>
            <div
              class="stat-card card-base"
              style="text-align: center; padding: 1.5rem"
            >
              <div
                class="stat-icon"
                style="font-size: 2.5rem; margin-bottom: 0.5rem"
              >
                <i class="fas fa-smile"></i>
              </div>
              <div class="stat-content">
                <div
                  class="stat-number"
                  id="most-common-mood-stat"
                  style="
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: var(--accent-pink);
                    margin-bottom: 0.25rem;
                  "
                >
                  -
                </div>
                <div
                  class="stat-label"
                  style="color: var(--text-secondary); font-size: 0.9rem"
                >
                  Most Common Mood
                </div>
              </div>
            </div>
          </div>

          <!-- Mood Heatmap Section -->
          <div class="chart-container card-base" style="margin-bottom: 2rem">
            <h3
              style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 1.5rem;
              "
            >
              <i class="fas fa-calendar-alt"></i> Mood Heatmap
              <span
                style="
                  font-size: 0.8rem;
                  color: var(--text-secondary);
                  font-weight: normal;
                  margin-left: auto;
                "
              >
                Last 365 days
              </span>
            </h3>
            <div
              id="mood-heatmap-container"
              style="overflow-x: auto; padding: 1rem 0"
            >
              <div id="mood-heatmap" style="min-width: 800px"></div>
            </div>
            <div
              class="heatmap-legend"
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 1rem;
                margin-top: 1rem;
                font-size: 0.85rem;
                color: var(--text-secondary);
              "
            >
              <span>Less</span>
              <div class="legend-scale" style="display: flex; gap: 2px">
                <div
                  class="legend-box"
                  style="
                    width: 12px;
                    height: 12px;
                    background: var(--bg-secondary);
                    border-radius: 2px;
                  "
                ></div>
                <div
                  class="legend-box"
                  style="
                    width: 12px;
                    height: 12px;
                    background: #c6e48b;
                    border-radius: 2px;
                  "
                ></div>
                <div
                  class="legend-box"
                  style="
                    width: 12px;
                    height: 12px;
                    background: #7bc96f;
                    border-radius: 2px;
                  "
                ></div>
                <div
                  class="legend-box"
                  style="
                    width: 12px;
                    height: 12px;
                    background: #239a3b;
                    border-radius: 2px;
                  "
                ></div>
                <div
                  class="legend-box"
                  style="
                    width: 12px;
                    height: 12px;
                    background: #196127;
                    border-radius: 2px;
                  "
                ></div>
              </div>
              <span>More</span>
            </div>
          </div>

          <!-- Mood Calendar View Section -->
          <div class="chart-container card-base" style="margin-bottom: 2rem">
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
              "
            >
              <h3
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                  margin: 0;
                "
              >
                <i class="fas fa-calendar"></i> Mood Calendar
              </h3>
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 1rem;
                  flex-wrap: wrap;
                "
              >
                <div
                  class="calendar-view-toggle"
                  style="
                    display: flex;
                    background: var(--bg-secondary);
                    border-radius: 8px;
                    padding: 2px;
                  "
                >
                  <button
                    id="month-view-btn"
                    class="view-toggle-btn active"
                    style="
                      padding: 6px 12px;
                      border: none;
                      background: var(--accent-blue);
                      color: white;
                      border-radius: 6px;
                      font-size: 0.8rem;
                      cursor: pointer;
                      transition: all 0.3s ease;
                    "
                  >
                    <i class="fas fa-calendar-alt"></i> Month
                  </button>
                  <button
                    id="week-view-btn"
                    class="view-toggle-btn"
                    style="
                      padding: 6px 12px;
                      border: none;
                      background: transparent;
                      color: var(--text-secondary);
                      border-radius: 6px;
                      font-size: 0.8rem;
                      cursor: pointer;
                      transition: all 0.3s ease;
                    "
                  >
                    <i class="fas fa-calendar-week"></i> Week
                  </button>
                </div>
                <div
                  class="calendar-navigation"
                  style="display: flex; align-items: center; gap: 0.5rem"
                >
                  <button
                    id="calendar-prev"
                    style="
                      padding: 6px 10px;
                      border: none;
                      background: var(--bg-secondary);
                      color: var(--text-primary);
                      border-radius: 6px;
                      cursor: pointer;
                      transition: all 0.3s ease;
                    "
                  >
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <span
                    id="calendar-current-period"
                    style="
                      font-weight: 600;
                      min-width: 120px;
                      text-align: center;
                      font-size: 0.9rem;
                    "
                  >
                    December 2023
                  </span>
                  <button
                    id="calendar-next"
                    style="
                      padding: 6px 10px;
                      border: none;
                      background: var(--bg-secondary);
                      color: var(--text-primary);
                      border-radius: 6px;
                      cursor: pointer;
                      transition: all 0.3s ease;
                    "
                  >
                    <i class="fas fa-chevron-right"></i>
                  </button>
                  <button
                    id="calendar-today"
                    style="
                      padding: 6px 12px;
                      border: none;
                      background: var(--accent-orange);
                      color: white;
                      border-radius: 6px;
                      font-size: 0.8rem;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      margin-left: 0.5rem;
                    "
                  >
                    <i class="fas fa-home"></i> Today
                  </button>
                </div>
              </div>
            </div>
            <div id="mood-calendar-container" style="overflow-x: auto">
              <div id="mood-calendar" style="min-width: 300px"></div>
            </div>
            <div
              id="calendar-mood-details"
              style="
                margin-top: 1rem;
                padding: 1rem;
                background: var(--bg-secondary);
                border-radius: 8px;
                display: none;
              "
            >
              <h4 style="margin: 0 0 0.5rem 0; color: var(--text-primary)">
                <i class="fas fa-info-circle"></i>
                <span id="selected-date-title">Selected Date</span>
              </h4>
              <div id="selected-date-moods"></div>
            </div>
          </div>

          <div class="chart-grid">
            <div class="chart-container card-base">
              <h3>📈 Mood Frequency Over Time</h3>
              <div class="chart-wrapper">
                <canvas id="moodFrequencyChart"></canvas>
              </div>
            </div>
            <div class="chart-container card-base">
              <h3>🎯 Overall Distribution</h3>
              <div class="chart-wrapper">
                <canvas id="moodDistributionChart"></canvas>
              </div>
            </div>
            <div class="chart-container card-base">
              <h3>🏅 Top 5 Moods</h3>
              <div class="chart-wrapper">
                <canvas id="topMoodsChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Insights Section -->
          <div class="insights-section" style="margin-top: 2rem">
            <h3
              style="
                color: var(--accent-purple);
                margin-bottom: 1.5rem;
                text-align: center;
              "
            >
              💡 Your Mood Insights
            </h3>
            <div
              class="insights-grid"
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
              "
            >
              <div class="insight-card card-base" style="padding: 1.5rem">
                <h4
                  style="
                    color: var(--accent-blue);
                    margin-bottom: 1rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                  "
                >
                  <span>🎯</span> Your Mood Journey
                </h4>
                <p
                  id="mood-journey-insight"
                  style="color: var(--text-secondary); line-height: 1.6"
                >
                  Track your moods to see patterns and insights here.
                </p>
              </div>
              <div class="insight-card card-base" style="padding: 1.5rem">
                <h4
                  style="
                    color: var(--accent-orange);
                    margin-bottom: 1rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                  "
                >
                  <span><i class="fas fa-chart-bar"></i></span> Weekly Summary
                </h4>
                <p
                  id="weekly-summary-insight"
                  style="color: var(--text-secondary); line-height: 1.6"
                >
                  Add more mood entries to see your weekly patterns.
                </p>
              </div>
              <div class="insight-card card-base" style="padding: 1.5rem">
                <h4
                  style="
                    color: var(--accent-pink);
                    margin-bottom: 1rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                  "
                >
                  <span>🌟</span> Recommendations
                </h4>
                <p
                  id="recommendations-insight"
                  style="color: var(--text-secondary); line-height: 1.6"
                >
                  Keep logging your moods to get personalized recommendations.
                </p>
              </div>
            </div>
          </div>

          <div id="reason-snippets-container">
            {/* Reason snippets will be styled individually */}
          </div>
        </section>

        <!-- Quote Explorer Page -->
        <section id="mood-slider-page" class="page">
          <h2 class="page-title">
            <i class="fas fa-compass"></i> Anime Quote Explorer
          </h2>

          <!-- Liked Quotes Section -->
          <div id="liked-quotes-explorer-section">
            <h3 class="sub-section-title">
              <i class="fas fa-heart"></i> Your Liked Quotes
            </h3>
            <div id="liked-quotes-explorer-list">
              {/* Liked quote cards will be rendered here by JS */}
            </div>
          </div>

          <!-- General Filters and Quote Results -->
          <h3 class="sub-section-title" id="explore-all-quotes-title">
            Discover New Quotes
          </h3>
          <div id="mood-filter-container">
            <label for="mood-filter-select">Filter by Mood:</label>
            <select id="mood-filter-select" class="filter-control"></select>
            <button
              id="quote-mode-toggle"
              class="filter-control"
              title="Toggle Random/Mood Quotes"
            >
              🎲 Random Quotes
            </button>
            <button
              id="theme-toggle"
              class="filter-control"
              title="Toggle Theme"
            >
              ☀️ Light Mode
            </button>
          </div>
          <div id="quote-slider-results">
            {/* Quote cards styled by .quote-card, will now include .like-btn
            */}
          </div>
        </section>

        <!-- Public Mood Page -->
        <section id="public-mood-page" class="page">
          <h2 class="page-title">
            <i class="fas fa-users"></i> Community Mood Feed
          </h2>

          <!-- View Toggle Section -->
          <div
            class="public-mood-controls"
            style="
              display: flex;
              justify-content: center;
              align-items: center;
              gap: 1rem;
              margin-bottom: 2rem;
            "
          >
            <div
              class="view-toggle-container"
              style="
                display: flex;
                background: var(--bg-secondary);
                border-radius: 8px;
                padding: 4px;
              "
            >
              <button
                id="public-feed-btn"
                class="view-toggle-btn active"
                style="
                  padding: 8px 16px;
                  border: none;
                  background: var(--accent-blue);
                  color: white;
                  border-radius: 6px;
                  font-size: 0.9rem;
                  cursor: pointer;
                  transition: all 0.3s ease;
                "
              >
                <i class="fas fa-globe"></i> Public Feed
              </button>
              <button
                id="my-public-moods-btn"
                class="view-toggle-btn"
                style="
                  padding: 8px 16px;
                  border: none;
                  background: transparent;
                  color: var(--text-secondary);
                  border-radius: 6px;
                  font-size: 0.9rem;
                  cursor: pointer;
                  transition: all 0.3s ease;
                "
              >
                <i class="fas fa-user"></i> My Public Moods
              </button>
            </div>
          </div>

          <!-- Public Mood Feed Container -->
          <div id="public-mood-feed" style="max-width: 800px; margin: 0 auto">
            <!-- Public mood cards will be rendered here -->
          </div>

          <!-- My Public Moods Container -->
          <div
            id="my-public-moods"
            style="max-width: 800px; margin: 0 auto; display: none"
          >
            <!-- User's own public mood cards will be rendered here -->
          </div>

          <!-- Empty State -->
          <div
            id="public-mood-empty-state"
            style="
              text-align: center;
              padding: 3rem;
              color: var(--text-secondary);
              display: none;
            "
          >
            <i
              class="fas fa-users"
              style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5"
            ></i>
            <h3>No Public Moods Yet</h3>
            <p>Be the first to share your mood with the community!</p>
            <p style="font-size: 0.9rem; margin-top: 1rem">
              <i class="fas fa-info-circle"></i> Enable public mood sharing in
              your Profile settings
            </p>
          </div>
        </section>

        <!-- History Page -->
        <section id="history-page" class="page">
          <h2 class="page-title">
            <i class="fas fa-history"></i> Your Quote Journey
          </h2>
          <div id="history-controls">
            <input
              type="text"
              id="history-search-term"
              class="filter-control"
              placeholder="Search quote, anime, character..."
            />
            <select id="history-mood-filter" class="filter-control">
              <option value="">Filter by Mood</option>
            </select>
            <input
              type="date"
              id="history-date-filter"
              class="filter-control"
              title="Filter by date"
            />
            <button id="clear-history-filters" class="filter-control">
              Clear Filters
            </button>
          </div>
          <div id="history-list">
            {/* History items styled by .history-item, favorite button removed
            from here */}
          </div>
        </section>

        <!-- Profile Page -->
        <section id="profile-page" class="page">
          <h2 class="page-title"><i class="fas fa-user"></i> Your Profile</h2>

          <div
            class="profile-container"
            style="max-width: 600px; margin: 0 auto"
          >
            <!-- Profile Info Card -->
            <div class="card-base" style="padding: 2rem; margin-bottom: 2rem">
              <h3
                style="
                  color: var(--accent-purple);
                  margin-bottom: 1.5rem;
                  text-align: center;
                "
              >
                Account Information
              </h3>

              <div class="profile-info">
                <div class="profile-field" style="margin-bottom: 1rem">
                  <label
                    style="
                      font-weight: 600;
                      color: var(--text-secondary);
                      display: block;
                      margin-bottom: 0.5rem;
                    "
                    >Display Name</label
                  >
                  <div style="display: flex; gap: 1rem; align-items: center">
                    <input
                      type="text"
                      id="profile-display-name"
                      style="
                        flex: 1;
                        padding: 0.75rem;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: var(--bg-main);
                      "
                      placeholder="Enter your display name"
                    />
                    <button
                      id="update-display-name-btn"
                      style="
                        padding: 0.75rem 1.5rem;
                        background: var(--accent-purple);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                      "
                    >
                      Update
                    </button>
                  </div>
                </div>

                <div class="profile-field" style="margin-bottom: 1rem">
                  <label
                    style="
                      font-weight: 600;
                      color: var(--text-secondary);
                      display: block;
                      margin-bottom: 0.5rem;
                    "
                    >Email</label
                  >
                  <input
                    type="email"
                    id="profile-email"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border: 1px solid var(--border-color);
                      border-radius: 8px;
                      background: var(--bg-main);
                    "
                    readonly
                  />
                </div>

                <div class="profile-field">
                  <label
                    style="
                      font-weight: 600;
                      color: var(--text-secondary);
                      display: block;
                      margin-bottom: 0.5rem;
                    "
                    >Member Since</label
                  >
                  <input
                    type="text"
                    id="profile-member-since"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border: 1px solid var(--border-color);
                      border-radius: 8px;
                      background: var(--bg-main);
                    "
                    readonly
                  />
                </div>
              </div>
            </div>

            <!-- Stats Card -->
            <div class="card-base" style="padding: 2rem; margin-bottom: 2rem">
              <h3
                style="
                  color: var(--accent-blue);
                  margin-bottom: 1.5rem;
                  text-align: center;
                "
              >
                Your Statistics
              </h3>

              <div
                class="stats-grid"
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                  gap: 1.5rem;
                "
              >
                <div
                  class="stat-item"
                  style="
                    text-align: center;
                    padding: 1rem;
                    background: var(--bg-main);
                    border-radius: 12px;
                  "
                >
                  <div
                    style="
                      font-size: 2rem;
                      color: var(--accent-orange);
                      margin-bottom: 0.5rem;
                    "
                  >
                    <i class="fas fa-fire"></i>
                  </div>
                  <div
                    style="
                      font-size: 1.5rem;
                      font-weight: 700;
                      color: var(--text-primary);
                    "
                    id="profile-current-streak"
                  >
                    0
                  </div>
                  <div style="font-size: 0.9rem; color: var(--text-secondary)">
                    Current Streak
                  </div>
                </div>

                <div
                  class="stat-item"
                  style="
                    text-align: center;
                    padding: 1rem;
                    background: var(--bg-main);
                    border-radius: 12px;
                  "
                >
                  <div
                    style="
                      font-size: 2rem;
                      color: var(--accent-blue);
                      margin-bottom: 0.5rem;
                    "
                  >
                    <i class="fas fa-trophy"></i>
                  </div>
                  <div
                    style="
                      font-size: 1.5rem;
                      font-weight: 700;
                      color: var(--text-primary);
                    "
                    id="profile-highest-streak"
                  >
                    0
                  </div>
                  <div style="font-size: 0.9rem; color: var(--text-secondary)">
                    Highest Streak
                  </div>
                </div>

                <div
                  class="stat-item"
                  style="
                    text-align: center;
                    padding: 1rem;
                    background: var(--bg-main);
                    border-radius: 12px;
                  "
                >
                  <div
                    style="
                      font-size: 2rem;
                      color: var(--accent-pink);
                      margin-bottom: 0.5rem;
                    "
                  >
                    <i class="fas fa-chart-bar"></i>
                  </div>
                  <div
                    style="
                      font-size: 1.5rem;
                      font-weight: 700;
                      color: var(--text-primary);
                    "
                    id="profile-total-entries"
                  >
                    0
                  </div>
                  <div style="font-size: 0.9rem; color: var(--text-secondary)">
                    Total Entries
                  </div>
                </div>

                <div
                  class="stat-item"
                  style="
                    text-align: center;
                    padding: 1rem;
                    background: var(--bg-main);
                    border-radius: 12px;
                  "
                >
                  <div
                    style="
                      font-size: 2rem;
                      color: var(--accent-purple);
                      margin-bottom: 0.5rem;
                    "
                  >
                    <i class="fas fa-calendar-alt"></i>
                  </div>
                  <div
                    style="
                      font-size: 1.5rem;
                      font-weight: 700;
                      color: var(--text-primary);
                    "
                    id="profile-last-entry"
                  >
                    Never
                  </div>
                  <div style="font-size: 0.9rem; color: var(--text-secondary)">
                    Last Entry
                  </div>
                </div>
              </div>
            </div>

            <!-- Account Actions -->
            <div class="card-base" style="padding: 2rem">
              <h3
                style="
                  color: var(--accent-pink);
                  margin-bottom: 1.5rem;
                  text-align: center;
                "
              >
                Account Actions
              </h3>

              <div style="display: flex; flex-direction: column; gap: 1rem">
                <button
                  id="public-mood-sharing-toggle"
                  style="
                    padding: 1rem;
                    background: var(--accent-purple);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    transition: all 0.3s ease;
                  "
                >
                  <i class="fas fa-users"></i> Public Mood Sharing: OFF
                </button>

                <button
                  id="performance-toggle"
                  style="
                    padding: 1rem;
                    background: var(--accent-orange);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    transition: all 0.3s ease;
                  "
                >
                  <i class="fas fa-bolt"></i> Performance Mode: OFF
                </button>

                <button
                  id="delete-account-btn"
                  style="
                    padding: 1rem;
                    background: #ef4444;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    transition: all 0.3s ease;
                  "
                >
                  <i class="fas fa-trash-alt"></i> Delete Account
                </button>
              </div>
            </div>
          </div>
        </section>
      </main>

      <!-- Modal for Mood Reason -->
      <div id="mood-reason-modal" class="modal">
        <div class="modal-content modal-content-base">
          <h3 id="modal-mood-name">Tell me more about feeling ...</h3>
          <textarea
            id="mood-reason-input"
            placeholder="Why do you feel this way? A few words can help you reflect. (Optional)"
          ></textarea>
          <div
            id="modal-quote-display"
            class="quote-card no-hover"
            style="display: none; margin-top: 0; cursor: default"
          ></div>
          <div class="modal-buttons">
            <button id="save-mood-button" class="modal-button-base">
              <i class="fas fa-save"></i> Save Mood
            </button>
            <button
              id="close-modal-button"
              class="modal-button-base close-button"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Redesigned Quote View Modal -->
      <div id="quote-view-modal" class="modal">
        <div class="quote-view-content modal-content-base">
          <button
            id="close-quote-view-button"
            class="close-quote-view"
            title="Close"
          >
            ×
          </button>
          <div id="quote-view-details">
            {/* Dynamic content styled via quote-view-* rules */}
          </div>
        </div>
      </div>

      <!-- Info Modal Added -->
      <div id="info-modal" class="modal">
        <div class="modal-content modal-content-base">
          <button id="close-info-modal-button" title="Close">×</button>
          <h3 class="info-modal-title">About DevMoodMirror ✨</h3>

          <!-- Language Toggle -->
          <div style="text-align: center; margin-bottom: 1rem">
            <button
              id="language-toggle-btn"
              style="
                background: var(--accent-purple);
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
              "
            >
              <i class="fas fa-globe"></i> Switch to Hinglish
            </button>
          </div>

          <div class="info-modal-content">
            <!-- English Content -->
            <div id="english-content">
              <p>
                <strong>Welcome to DevMoodMirror!</strong> Your personal mood
                tracking app that helps you understand your emotions and find
                inspiration through anime quotes.
              </p>

              <h4 style="color: var(--accent-purple); margin-top: 1.5rem">
                <i class="fas fa-bullseye"></i> What You Can Do:
              </h4>
              <ul style="margin-bottom: 1.5rem">
                <li>
                  <strong><i class="fas fa-home"></i> Home:</strong> Pick your
                  current mood from the grid. Add a reason if you want. Get a
                  matching anime quote!
                </li>
                <li>
                  <strong><i class="fas fa-chart-line"></i> Analytics:</strong>
                  See your mood patterns with charts and graphs. Track your
                  daily streak too!
                </li>
                <li>
                  <strong><i class="fas fa-compass"></i> Explorer:</strong>
                  Browse thousands of anime quotes. Filter by mood or explore
                  randomly. Save your favorites with ❤️
                </li>
                <li>
                  <strong><i class="fas fa-users"></i> Public Moods:</strong>
                  Share your moods with the community and see how others are
                  feeling. Connect with fellow mood trackers!
                </li>
                <li>
                  <strong><i class="fas fa-history"></i> History:</strong> Look
                  at your past mood entries. Search and filter to find specific
                  moods or dates.
                </li>
                <li>
                  <strong><i class="fas fa-user"></i> Profile:</strong> Check
                  your stats, change your name, and download your data.
                </li>
              </ul>

              <h4 style="color: var(--accent-orange); margin-top: 1.5rem">
                <i class="fas fa-fire"></i> Cool Features:
              </h4>
              <ul style="margin-bottom: 1.5rem">
                <li>
                  <strong>Daily Streaks:</strong> Log your mood every day to
                  build streaks
                </li>
                <li>
                  <strong>Smart Insights:</strong> Get personalized tips and
                  recommendations
                </li>
                <li>
                  <strong>Huge Quote Library:</strong> 1000+ anime quotes with
                  character names
                </li>
                <li>
                  <strong>Export Data:</strong> Download all your data anytime
                </li>
                <li>
                  <strong>Private & Safe:</strong> Your data is completely
                  secure
                </li>
              </ul>

              <h4 style="color: var(--accent-pink); margin-top: 1.5rem">
                👥 Coming Soon - Social Features:
              </h4>
              <div
                style="
                  background: var(--bg-secondary);
                  padding: 1rem;
                  border-radius: 8px;
                  margin: 1rem 0;
                "
              >
                <p
                  style="
                    margin: 0;
                    color: var(--text-secondary);
                    font-style: italic;
                  "
                >
                  🚀 <strong>Future Updates:</strong><br />
                  • Add friends and see their mood trends<br />
                  • Share moods anonymously with community<br />
                  • Join mood challenges and goals<br />
                  • Get friend suggestions based on similar moods<br />
                  • Daily mood reminders
                </p>
              </div>

              <h4 style="color: var(--accent-blue); margin-top: 1.5rem">
                💡 Tips for Best Experience:
              </h4>
              <ul style="margin-bottom: 1.5rem">
                <li>Log your mood daily to build streaks</li>
                <li>Write honest reasons for better insights</li>
                <li>Try different moods to explore variety</li>
                <li>Save quotes that inspire you</li>
                <li>Check analytics regularly to see patterns</li>
              </ul>

              <p
                style="
                  text-align: center;
                  margin-top: 2rem;
                  padding: 1rem;
                  background: linear-gradient(
                    135deg,
                    var(--accent-purple),
                    var(--accent-pink)
                  );
                  color: white;
                  border-radius: 8px;
                "
              >
                <strong>🌟 Start tracking your emotions today!</strong><br />
                Understand yourself better with DevMoodMirror ✨
              </p>
            </div>

            <!-- Hinglish Content (Hidden by default) -->
            <div id="hinglish-content" style="display: none">
              <p>
                <strong>Welcome to DevMoodMirror!</strong> Aapka personal mood
                tracking app jo aapko apne emotions samjhane mein help karta hai
                aur anime quotes ke through inspiration deta hai.
              </p>

              <h4 style="color: var(--accent-purple); margin-top: 1.5rem">
                🎯 Aap Kya Kar Sakte Hain:
              </h4>
              <ul style="margin-bottom: 1.5rem">
                <li>
                  <strong>🏠 Home:</strong> Grid se apna current mood select
                  karo. Reason add kar sakte ho agar chahiye. Matching anime
                  quote milega!
                </li>
                <li>
                  <strong>📊 Analytics:</strong> Apne mood patterns dekho charts
                  aur graphs ke saath. Daily streak bhi track karo!
                </li>
                <li>
                  <strong>📜 Explorer:</strong> Hazaaron anime quotes browse
                  karo. Mood ke hisaab se filter karo ya randomly explore karo.
                  Favorites ko ❤️ se save karo
                </li>
                <li>
                  <strong>📖 History:</strong> Purane mood entries dekho. Search
                  aur filter karo specific moods ya dates find karne ke liye.
                </li>
                <li>
                  <strong>👤 Profile:</strong> Stats check karo, name change
                  karo, aur data download karo.
                </li>
              </ul>

              <h4 style="color: var(--accent-orange); margin-top: 1.5rem">
                🔥 Cool Features:
              </h4>
              <ul style="margin-bottom: 1.5rem">
                <li>
                  <strong>Daily Streaks:</strong> Roz mood log karo streak
                  banane ke liye
                </li>
                <li>
                  <strong>Smart Insights:</strong> Personalized tips aur
                  recommendations pao
                </li>
                <li>
                  <strong>Huge Quote Library:</strong> 1000+ anime quotes
                  character names ke saath
                </li>
                <li>
                  <strong>Export Data:</strong> Kabhi bhi apna saara data
                  download karo
                </li>
                <li>
                  <strong>Private & Safe:</strong> Aapka data bilkul secure hai
                </li>
              </ul>

              <h4 style="color: var(--accent-pink); margin-top: 1.5rem">
                👥 Coming Soon - Social Features:
              </h4>
              <div
                style="
                  background: var(--bg-secondary);
                  padding: 1rem;
                  border-radius: 8px;
                  margin: 1rem 0;
                "
              >
                <p
                  style="
                    margin: 0;
                    color: var(--text-secondary);
                    font-style: italic;
                  "
                >
                  🚀 <strong>Future Updates:</strong><br />
                  • Friends add karo aur unke mood trends dekho<br />
                  • Community ke saath anonymously moods share karo<br />
                  • Mood challenges aur goals join karo<br />
                  • Similar moods wale friends ke suggestions pao<br />
                  • Daily mood reminders
                </p>
              </div>

              <h4 style="color: var(--accent-blue); margin-top: 1.5rem">
                💡 Best Experience Ke Liye Tips:
              </h4>
              <ul style="margin-bottom: 1.5rem">
                <li>Daily mood log karo streak banane ke liye</li>
                <li>Honest reasons likho better insights ke liye</li>
                <li>Different moods try karo variety explore karne ke liye</li>
                <li>Jo quotes inspire karte hain unhe save karo</li>
                <li>Analytics regularly check karo patterns dekhne ke liye</li>
              </ul>

              <p
                style="
                  text-align: center;
                  margin-top: 2rem;
                  padding: 1rem;
                  background: linear-gradient(
                    135deg,
                    var(--accent-purple),
                    var(--accent-pink)
                  );
                  color: white;
                  border-radius: 8px;
                "
              >
                <strong>🌟 Aaj se apne emotions track karna start karo!</strong
                ><br />
                DevMoodMirror ke saath khud ko better samjho ✨
              </p>
            </div>
          </div>
          <p class="info-modal-credit">
            Developed with ❤️ by Dev | Version 2.0 with Firestore
          </p>
        </div>
      </div>
      <!-- End Info Modal -->
    </div>
    <!-- End #app-container -->

    <!-- CDN Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
      import {
        getFirestore,
        collection,
        doc,
        setDoc,
        getDoc,
        getDocs,
        addDoc,
        updateDoc,
        deleteDoc,
        query,
        where,
        orderBy,
        limit,
        onSnapshot,
        serverTimestamp,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        updateProfile,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA7Y7M-HQjnWmwTSlgSKxEPCctuUsGvqJI",
        authDomain: "mood-tracker-bccff.firebaseapp.com",
        databaseURL: "https://mood-tracker-bccff-default-rtdb.firebaseio.com",
        projectId: "mood-tracker-bccff",
        storageBucket: "mood-tracker-bccff.firebasestorage.app",
        messagingSenderId: "235334198263",
        appId: "1:235334198263:web:2adbceb86a9577c46b84f2",
        measurementId: "G-D9LRH4MS7R",
      };

      // Initialize Firebase
      const firebaseAppInstance = initializeApp(firebaseConfig);
      const analytics = getAnalytics(firebaseAppInstance);
      const db = getFirestore(firebaseAppInstance);
      const auth = getAuth(firebaseAppInstance);

      // Global variables for user state
      let currentUser = null;
      let userProfile = null;

      // Authentication state observer
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // User is signed in
          currentUser = user;
          console.log("User signed in:", user.email);

          // Show loading state
          showLoadingState();

          // Load user profile from Firestore
          try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              userProfile = userDoc.data();
            } else {
              // Create user profile if it doesn't exist
              userProfile = {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName || "User",
                createdAt: serverTimestamp(),
                currentStreak: 0,
                highestStreak: 0,
                totalMoodEntries: 0,
                lastMoodDate: null,
              };
              await setDoc(doc(db, "users", user.uid), userProfile);
            }

            // Update header with user info
            updateHeaderWithUserInfo();

            // Initialize the app if not already done
            if (typeof app !== "undefined" && app.init && !app.initialized) {
              await app.init();
              app.initialized = true;
            }

            // Hide loading state
            hideLoadingState();
          } catch (error) {
            console.error("Error loading user profile:", error);
            hideLoadingState();
            showErrorMessage(
              "Failed to load user data. Please refresh the page."
            );
          }
        } else {
          // User is signed out, redirect to landing page
          console.log("User signed out");
          currentUser = null;
          userProfile = null;

          // Only redirect if we're not already on auth pages
          const currentPath = window.location.pathname;
          if (
            !currentPath.includes("landingpage.html") &&
            !currentPath.includes("auth.html")
          ) {
            window.location.href = "landingpage.html";
          }
        }
      });

      // Loading state functions
      function showLoadingState() {
        const appContainer = document.getElementById("app-container");
        if (appContainer) {
          const loadingDiv = document.createElement("div");
          loadingDiv.id = "app-loading";
          loadingDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
          `;
          loadingDiv.innerHTML = `
            <div style="text-align: center;">
              <div style="width: 50px; height: 50px; border: 3px solid #f3f3f3; border-top: 3px solid var(--accent-purple); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
              <p style="color: var(--text-primary); font-weight: 600;">Loading your mood data...</p>
            </div>
          `;
          appContainer.appendChild(loadingDiv);
        }
      }

      function hideLoadingState() {
        const loadingDiv = document.getElementById("app-loading");
        if (loadingDiv) {
          loadingDiv.remove();
        }
      }

      function showErrorMessage(message) {
        const errorDiv = document.createElement("div");
        errorDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #ef4444;
          color: white;
          padding: 1rem 1.5rem;
          border-radius: 8px;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        `;
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);

        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      }

      // Function to update header with user information
      function updateHeaderWithUserInfo() {
        const header = document.querySelector("header h1");
        if (header && userProfile) {
          // Add user greeting and logout button
          const userInfo = document.createElement("div");
          userInfo.id = "user-info";
          userInfo.style.cssText = `
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: var(--text-secondary);
          `;

          userInfo.innerHTML = `
            <span>Welcome, ${userProfile.displayName}!</span>
            <button id="logout-btn" style="
              background: var(--accent-pink);
              color: white;
              border: none;
              padding: 5px 10px;
              border-radius: 15px;
              font-size: 0.8em;
              cursor: pointer;
              transition: all 0.3s ease;
            "><i class="fas fa-sign-out-alt"></i> Logout</button>
          `;

          // Remove existing user info if present
          const existingUserInfo = document.getElementById("user-info");
          if (existingUserInfo) {
            existingUserInfo.remove();
          }

          header.parentElement.appendChild(userInfo);

          // Add logout functionality
          document
            .getElementById("logout-btn")
            .addEventListener("click", async () => {
              try {
                await signOut(auth);
              } catch (error) {
                console.error("Error signing out:", error);
              }
            });
        }
      }

      // Import quotes from the separate file
      import { ANIME_QUOTES } from "./quotes.js";

      // --- UPDATED DATA DEFINITIONS (Moods) ---
      const MOOD_LIST = [
        { emoji: "😀", name: "Grinning" },
        { emoji: "😁", name: "Beaming" },
        { emoji: "😂", name: "Joy" },
        { emoji: "🤣", name: "ROFL" },
        { emoji: "😃", name: "Smiley" },
        { emoji: "😄", name: "Smile" },
        { emoji: "😎", name: "Cool" },
        { emoji: "😋", name: "Yum" },
        { emoji: "😊", name: "Blush" },
        { emoji: "😉", name: "Wink" },
        { emoji: "😆", name: "Laughing" },
        { emoji: "😅", name: "Sweat Smile" },
        { emoji: "😍", name: "Heart Eyes" },
        { emoji: "😘", name: "Kissing Heart" },
        { emoji: "🥰", name: "Smiling Heart" },
        { emoji: "😗", name: "Kissing" },
        { emoji: "😙", name: "Kissing Smile" },
        { emoji: "🥲", name: "Smiling Tear" },
        { emoji: "😚", name: "Kissing Closed Eyes" },
        { emoji: "☺️", name: "Smiling Face" },
        { emoji: "🙂", name: "Slight Smile" },
        { emoji: "🤗", name: "Hugging" },
        { emoji: "🤩", name: "Star-Struck" },
        { emoji: "🤔", name: "Thinking" },
        { emoji: "🫥", name: "Dotted Line" },
        { emoji: "😶", name: "No Mouth" },
        { emoji: "😑", name: "Expressionless" },
        { emoji: "😐", name: "Neutral" },
        { emoji: "🤨", name: "Raised Eyebrow" },
        { emoji: "🫡", name: "Saluting" },
        { emoji: "😶‍🌫️", name: "Face in Clouds" },
        { emoji: "🙄", name: "Rolling Eyes" },
        { emoji: "😏", name: "Smirking" },
        { emoji: "😣", name: "Persevering" },
        { emoji: "😥", name: "Sad But Relieved" },
        { emoji: "😮", name: "Open Mouth" },
        { emoji: "😴", name: "Sleeping" },
        { emoji: "🥱", name: "Yawning" },
        { emoji: "😫", name: "Tired Face" },
        { emoji: "😪", name: "Sleepy" },
        { emoji: "😯", name: "Hushed" },
        { emoji: "🤐", name: "Zipper Mouth" },
        { emoji: "😌", name: "Relieved" },
        { emoji: "😓", name: "Cold Sweat" },
        { emoji: "😔", name: "Pensive" },
        { emoji: "😛", name: "Stuck-Out Tongue" },
        { emoji: "😜", name: "Winking Tongue" },
        { emoji: "😝", name: "Squinting Tongue" },
        { emoji: "🤤", name: "Drooling" },
        { emoji: "😒", name: "Unamused" },
        { emoji: "🫠", name: "Melting" },
        { emoji: "🙃", name: "Upside-Down" },
        { emoji: "🫤", name: "Diagonal Mouth" },
        { emoji: "😕", name: "Confused" },
        { emoji: "☹️", name: "Frowning" },
        { emoji: "😲", name: "Astonished" },
        { emoji: "🤑", name: "Money Mouth" },
        { emoji: "🙁", name: "Slight Frown" },
        { emoji: "😖", name: "Confounded" },
        { emoji: "😞", name: "Disappointed" },
        { emoji: "😟", name: "Worried" },
        { emoji: "😤", name: "Triumph" },
        { emoji: "😢", name: "Crying" },
        { emoji: "😭", name: "Loudly Crying" },
        { emoji: "😧", name: "Anguished" },
        { emoji: "😰", name: "Anxious Sweat" },
        { emoji: "😦", name: "Frowning Open Mouth" },
        { emoji: "😮‍💨", name: "Exhaling" },
        { emoji: "😬", name: "Grimacing" },
        { emoji: "🤯", name: "Exploding Head" },
        { emoji: "😩", name: "Weary" },
        { emoji: "😨", name: "Fearful" },
        { emoji: "😱", name: "Screaming" },
        { emoji: "🥵", name: "Hot Face" },
        { emoji: "🥶", name: "Cold Face" },
        { emoji: "😳", name: "Flushed" },
        { emoji: "🤪", name: "Zany" },
        { emoji: "😵", name: "Dizzy" },
        { emoji: "😷", name: "Face with Mask" },
        { emoji: "🤬", name: "Symbols on Mouth" },
        { emoji: "😡", name: "Pouting" },
        { emoji: "😠", name: "Angry" },
        { emoji: "🥴", name: "Woozy" },
        { emoji: "😵‍💫", name: "Spiral Eyes" },
        { emoji: "🤒", name: "Thermometer" },
        { emoji: "🤕", name: "Bandaged Head" },
        { emoji: "🤢", name: "Nauseated" },
        { emoji: "🤮", name: "Vomiting" },
        { emoji: "🤧", name: "Sneezing" },
        { emoji: "😇", name: "Smiling Halo" },
        { emoji: "🥳", name: "Partying" },
        { emoji: "🥸", name: "Disguised" },
        { emoji: "🥺", name: "Pleading" },
        { emoji: "🥹", name: "Holding Back Tears" },
        { emoji: "🤠", name: "Cowboy Hat" },
        { emoji: "🤡", name: "Clown" },
        { emoji: "🤭", name: "Hand Over Mouth" },
        { emoji: "🤫", name: "Shushing" },
        { emoji: "🙂‍↔️", name: "Head Shaking Horizontally" },
        { emoji: "🫨", name: "Shaking Face" },
        { emoji: "🤥", name: "Lying" },
        { emoji: "🫢", name: "Eyes Peeking" },
        { emoji: "🫣", name: "Hand Covering Eyes" },
        { emoji: "🧐", name: "Monocle" },
        { emoji: "🤓", name: "Nerdy" },
        { emoji: "😈", name: "Smiling Imp" },
        { emoji: "👿", name: "Angry Imp" },
        { emoji: "👻", name: "Ghost" },
        { emoji: "💀", name: "Skull" },
        { emoji: "☠️", name: "Skull Crossbones" },
        { emoji: "👺", name: "Goblin" },
        { emoji: "👹", name: "Ogre" },
      ];

      // --- P5.JS BACKGROUND WITH FLOATING EMOJIS ---
      let particles = [];
      let emojiParticles = [];
      let p5Instance;

      // Mood emojis for background
      const backgroundEmojis = [
        "😊",
        "😢",
        "😡",
        "😴",
        "🤔",
        "😍",
        "😎",
        "🥳",
        "😌",
        "🤗",
        "😅",
        "😭",
        "😤",
        "🥺",
        "😇",
        "🤪",
        "😋",
        "😉",
        "🙂",
        "😐",
        "😕",
        "😟",
        "😰",
        "😱",
        "🤯",
        "😵",
        "🥴",
        "🤒",
        "🤕",
        "🤢",
        "😷",
        "🤧",
        "🥶",
        "🥵",
        "😳",
        "🤭",
        "🤫",
        "🤥",
        "😬",
        "🙄",
        "😏",
        "😒",
        "😞",
        "😔",
        "😪",
        "🤤",
        "😴",
        "😵‍💫",
        "🤠",
        "🥸",
      ];

      function setupFlowingBackground(p) {
        p.setup = () => {
          let canvas = p.createCanvas(p.windowWidth, p.windowHeight);
          canvas.parent("flowing-background");

          // Limit frame rate for better performance
          p.frameRate(30);

          // Create fewer regular particles for better performance
          for (let i = 0; i < 15; i++) {
            particles.push(new Particle(p));
          }

          // Create fewer emoji particles for better performance
          for (let i = 0; i < 12; i++) {
            emojiParticles.push(new EmojiParticle(p));
          }

          p.noStroke();
          p5Instance = p;
        };

        p.draw = () => {
          const bgMain = p.color(
            getComputedStyle(document.documentElement)
              .getPropertyValue("--bg-main")
              .trim()
          );
          const particleColor = p.color(
            getComputedStyle(document.documentElement)
              .getPropertyValue("--accent-purple")
              .trim()
          );
          particleColor.setAlpha(30); // Reduced opacity
          p.background(bgMain);

          // Draw regular particles
          for (let particle of particles) {
            particle.updateColor(particleColor);
            particle.update(p);
            particle.display(p);
          }

          // Draw emoji particles
          for (let emojiParticle of emojiParticles) {
            emojiParticle.update(p);
            emojiParticle.display(p);
          }
        };

        p.windowResized = () => {
          p.resizeCanvas(p.windowWidth, p.windowHeight);
        };
      }
      class Particle {
        /* ... Particle class remains the same ... */ constructor(p) {
          this.p = p;
          this.pos = p.createVector(p.random(p.width), p.random(p.height));
          this.vel = p5.Vector.random2D().mult(p.random(0.1, 0.4));
          this.acc = p.createVector(0, 0);
          this.maxSpeed = 0.6;
          this.color = p.color(200, 200, 200, 50);
          this.size = p.random(10, 35);
          this.noiseOffsetX = p.random(1000);
          this.noiseOffsetY = p.random(1000);
        }
        updateColor(newColor) {
          this.color = this.p.lerpColor(this.color, newColor, 0.05);
        }
        update() {
          let angle =
            this.p.noise(
              this.pos.x * 0.005,
              this.pos.y * 0.005,
              this.p.frameCount * 0.0015
            ) *
            this.p.TWO_PI *
            2;
          this.acc = p5.Vector.fromAngle(angle).mult(0.015);
          this.vel.add(this.acc);
          this.vel.limit(this.maxSpeed);
          this.pos.add(this.vel);
          this.edges();
        }
        display() {
          this.p.fill(this.color);
          this.p.ellipse(
            this.pos.x,
            this.pos.y,
            this.size *
              (this.p.sin(this.p.frameCount * 0.015 + this.noiseOffsetX) * 0.2 +
                0.9)
          );
        }
        edges() {
          if (this.pos.x > this.p.width + this.size) this.pos.x = -this.size;
          if (this.pos.x < -this.size) this.pos.x = this.p.width + this.size;
          if (this.pos.y > this.p.height + this.size) this.pos.y = -this.size;
          if (this.pos.y < -this.size) this.pos.y = this.p.height + this.size;
        }
      }

      // New EmojiParticle class for floating emojis
      class EmojiParticle {
        constructor(p) {
          this.p = p;
          this.pos = p.createVector(p.random(p.width), p.random(p.height));
          this.vel = p5.Vector.random2D().mult(p.random(0.2, 0.8));
          this.emoji = p.random(backgroundEmojis);
          this.size = p.random(20, 40);
          this.opacity = p.random(0.1, 0.3); // Low opacity for subtle effect
          this.rotationSpeed = p.random(-0.02, 0.02);
          this.rotation = 0;
          this.noiseOffset = p.random(1000);

          // Ensure good spacing between emojis
          this.minDistance = 80;
          this.checkSpacing();
        }

        checkSpacing() {
          // Check distance from other emoji particles
          for (let other of emojiParticles) {
            if (other !== this) {
              let distance = p5.Vector.dist(this.pos, other.pos);
              if (distance < this.minDistance) {
                // Reposition if too close
                this.pos = this.p.createVector(
                  this.p.random(this.p.width),
                  this.p.random(this.p.height)
                );
                break;
              }
            }
          }
        }

        update(p) {
          // Gentle floating movement with noise
          let angle =
            p.noise(
              this.pos.x * 0.003,
              this.pos.y * 0.003,
              p.frameCount * 0.001 + this.noiseOffset
            ) *
            p.TWO_PI *
            2;

          let force = p5.Vector.fromAngle(angle).mult(0.01);
          this.vel.add(force);
          this.vel.limit(0.5);
          this.pos.add(this.vel);

          // Gentle rotation
          this.rotation += this.rotationSpeed;

          // Wrap around edges
          this.edges();
        }

        display(p) {
          p.push();
          p.translate(this.pos.x, this.pos.y);
          p.rotate(this.rotation);

          // Optimized rendering - no shadow for better performance
          p.fill(255, 255, 255, this.opacity * 255);
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(this.size);
          p.text(this.emoji, 0, 0);

          p.pop();
        }

        edges() {
          if (this.pos.x > this.p.width + this.size) this.pos.x = -this.size;
          if (this.pos.x < -this.size) this.pos.x = this.p.width + this.size;
          if (this.pos.y > this.p.height + this.size) this.pos.y = -this.size;
          if (this.pos.y < -this.size) this.pos.y = this.p.height + this.size;
        }
      }

      // --- FLOATING EMOJI BACKGROUND ---
      function createFloatingEmojis() {
        const container = document.getElementById("floating-emoji-bg");
        if (!container) return;

        const emojis = [
          "😊",
          "😢",
          "😡",
          "😴",
          "🤔",
          "😍",
          "😎",
          "🥳",
          "😌",
          "🤗",
          "😅",
          "😭",
          "😤",
          "🥺",
          "😇",
          "🤪",
          "😋",
          "😉",
          "🙂",
          "😐",
          "😕",
          "😟",
          "😰",
          "😱",
          "🤯",
          "😵",
          "🥴",
          "🤒",
          "🤕",
          "🤢",
        ];

        // Create initial floating emojis
        for (let i = 0; i < 15; i++) {
          createFloatingEmoji(container, emojis);
        }

        // Continuously create new emojis
        setInterval(() => {
          if (container.children.length < 20) {
            createFloatingEmoji(container, emojis);
          }
        }, 3000);
      }

      function createFloatingEmoji(container, emojis) {
        // Check if performance mode is enabled
        if (window.app && window.app.performanceMode) {
          // Reduce floating emojis in performance mode
          if (container.children.length >= 5) return;
        }

        const emoji = document.createElement("div");
        emoji.className = "floating-emoji";
        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];

        // Random size class
        const sizeClasses = ["small", "", "large"];
        const randomSize =
          sizeClasses[Math.floor(Math.random() * sizeClasses.length)];
        if (randomSize) emoji.classList.add(randomSize);

        // Random horizontal position
        emoji.style.left = Math.random() * 100 + "%";

        // Random animation delay
        emoji.style.animationDelay = Math.random() * 5 + "s";

        container.appendChild(emoji);

        // Remove emoji after animation completes
        setTimeout(() => {
          if (emoji.parentNode) {
            emoji.parentNode.removeChild(emoji);
          }
        }, 20000);
      }

      // --- APP LOGIC ---
      document.addEventListener("DOMContentLoaded", () => {
        // Initialize floating emojis
        createFloatingEmojis();
        // Make app globally accessible for auth state observer
        window.app = {
          // --- Element getters ---
          get moodGrid() {
            return document.getElementById("mood-selection-grid");
          },
          get modal() {
            return document.getElementById("mood-reason-modal");
          },
          get modalContent() {
            return this.modal.querySelector(".modal-content");
          },
          get modalMoodName() {
            return document.getElementById("modal-mood-name");
          },
          get moodReasonInput() {
            return document.getElementById("mood-reason-input");
          },
          get modalQuoteDisplay() {
            return document.getElementById("modal-quote-display");
          },
          get saveMoodButton() {
            return document.getElementById("save-mood-button");
          },
          get closeModalButton() {
            return document.getElementById("close-modal-button");
          },
          get navButtons() {
            return document.querySelectorAll(".nav-button");
          },
          get pages() {
            return document.querySelectorAll(".page");
          },
          get moodFrequencyChartCtx() {
            return document
              .getElementById("moodFrequencyChart")
              ?.getContext("2d");
          },
          get moodDistributionChartCtx() {
            return document
              .getElementById("moodDistributionChart")
              ?.getContext("2d");
          },
          get topMoodsChartCtx() {
            return document.getElementById("topMoodsChart")?.getContext("2d");
          },
          get reasonSnippetsContainer() {
            return document.getElementById("reason-snippets-container");
          },
          get moodFilterSelect() {
            return document.getElementById("mood-filter-select");
          },
          get quoteModeToggle() {
            return document.getElementById("quote-mode-toggle");
          },
          get themeToggle() {
            return document.getElementById("theme-toggle");
          },
          get quoteSliderResults() {
            return document.getElementById("quote-slider-results");
          },
          get likedQuotesExplorerSection() {
            return document.getElementById("liked-quotes-explorer-section");
          },
          get likedQuotesExplorerList() {
            return document.getElementById("liked-quotes-explorer-list");
          },
          get historyList() {
            return document.getElementById("history-list");
          },
          get historySearchTerm() {
            return document.getElementById("history-search-term");
          },
          get historyMoodFilter() {
            return document.getElementById("history-mood-filter");
          },
          get historyDateFilter() {
            return document.getElementById("history-date-filter");
          },
          get clearHistoryFiltersBtn() {
            return document.getElementById("clear-history-filters");
          },
          get quoteViewModal() {
            return document.getElementById("quote-view-modal");
          },
          get quoteViewContent() {
            return this.quoteViewModal.querySelector(".quote-view-content");
          },
          get quoteViewDetails() {
            return document.getElementById("quote-view-details");
          },
          get closeQuoteViewButton() {
            return document.getElementById("close-quote-view-button");
          },
          get infoButton() {
            return document.getElementById("info-button");
          },
          get infoModal() {
            return document.getElementById("info-modal");
          },
          get infoModalContentElement() {
            return this.infoModal.querySelector(".modal-content");
          },
          get closeInfoModalButton() {
            return document.getElementById("close-info-modal-button");
          },
          // STREAK FEATURE: Element Getters
          get currentStreakValueEl() {
            return document.getElementById("current-streak-value");
          },
          get highestStreakValueEl() {
            return document.getElementById("highest-streak-value");
          },

          // PUBLIC MOOD FEATURE: Element Getters
          get publicMoodFeedContainer() {
            return document.getElementById("public-mood-feed");
          },
          get myPublicMoodsContainer() {
            return document.getElementById("my-public-moods");
          },
          get publicMoodEmptyState() {
            return document.getElementById("public-mood-empty-state");
          },
          get publicFeedBtn() {
            return document.getElementById("public-feed-btn");
          },
          get myPublicMoodsBtn() {
            return document.getElementById("my-public-moods-btn");
          },

          // --- Firebase and State ---
          db: db,
          auth: auth,
          currentStreak: 0,
          lastSuccessfulLogTimeForStreak: null, // Stores ISO string of the log that counted for the streak
          highestStreak: 0,

          currentSelectedMood: null,
          moodHistory: [],
          favoriteQuotes: [],
          publicMoods: [], // Array to store public mood feed
          myPublicMoods: [], // Array to store user's own public moods
          publicMoodSharingEnabled: false, // User preference for sharing moods publicly
          publicMoodViewMode: "feed", // 'feed' or 'my-moods'
          // STREAK FEATURE: Properties
          currentStreak: 0,
          highestStreak: 0,
          lastSuccessfulLogTimeForStreak: null,
          charts: {},
          quoteSliderMode: "mood", // 'mood' or 'random'
          isDarkTheme: false,
          activePage: "home",
          initialized: false,
          performanceMode: false, // Toggle for reduced animations

          // --- Core App Methods ---
          async init() {
            new p5(setupFlowingBackground);
            this.loadData(); // Loads theme, last page
            this.loadPerformancePreference(); // Load performance settings
            this.applyTheme();
            this.populateMoodGrid();
            this.setupEventListeners();
            this.populateMoodFilterDropdowns();
            this.updateThemeToggleButton();

            await this.setupFirebaseInitialData(); // Load mood history, favorites
            await this.loadAndCheckStreak(); // STREAK FEATURE: Load streak data and check for breaks

            this.navigateToPage(this.activePage, true); // Navigate after all initial data is loaded
            // Initial render if starting on explorer page
            if (this.activePage === "mood-slider") {
              this.renderLikedQuotesExplorer();
              this.loadQuotesForSlider();
            }
            this.setupFirebaseListeners(); // Setup live listeners after initial load
          },

          loadPerformancePreference() {
            const savedPerformanceMode = localStorage.getItem(
              "devMoodMirror_performanceMode"
            );
            if (savedPerformanceMode === "true") {
              this.performanceMode = true;
              console.log("Performance mode loaded from preferences");
            }
          },

          async loadAndCheckStreak() {
            if (!currentUser) return;

            try {
              // Load streak data from user profile
              if (userProfile) {
                this.currentStreak = userProfile.currentStreak || 0;
                this.highestStreak = userProfile.highestStreak || 0;

                // Handle different data types for lastMoodDate
                let lastMoodDate = userProfile.lastMoodDate;
                if (lastMoodDate) {
                  // Convert to Date object regardless of input type
                  if (typeof lastMoodDate === "string") {
                    this.lastSuccessfulLogTimeForStreak = new Date(
                      lastMoodDate
                    );
                  } else if (lastMoodDate.toDate) {
                    // Firestore Timestamp
                    this.lastSuccessfulLogTimeForStreak = lastMoodDate.toDate();
                  } else if (lastMoodDate instanceof Date) {
                    this.lastSuccessfulLogTimeForStreak = lastMoodDate;
                  } else {
                    this.lastSuccessfulLogTimeForStreak = null;
                  }
                } else {
                  this.lastSuccessfulLogTimeForStreak = null;
                }

                // Check if streak should be broken based on calendar days
                if (
                  this.currentStreak > 0 &&
                  this.lastSuccessfulLogTimeForStreak
                ) {
                  const today = new Date();
                  const lastLogDate = new Date(
                    this.lastSuccessfulLogTimeForStreak
                  );

                  // Get calendar days (ignore time)
                  const todayDateString = today.toDateString();
                  const lastLogDateString = lastLogDate.toDateString();
                  const yesterdayDateString = new Date(
                    today.getTime() - 24 * 60 * 60 * 1000
                  ).toDateString();

                  console.log("Streak check:", {
                    today: todayDateString,
                    yesterday: yesterdayDateString,
                    lastLog: lastLogDateString,
                    currentStreak: this.currentStreak,
                  });

                  // If last log was not today or yesterday, break the streak
                  if (
                    lastLogDateString !== todayDateString &&
                    lastLogDateString !== yesterdayDateString
                  ) {
                    console.log(
                      "Streak broken - last log was more than 1 day ago"
                    );
                    this.currentStreak = 0;
                    this.lastSuccessfulLogTimeForStreak = null;

                    // Update user profile
                    await updateDoc(doc(this.db, "users", currentUser.uid), {
                      currentStreak: 0,
                      lastMoodDate: null,
                    });

                    // Update userProfile object
                    userProfile.currentStreak = 0;
                    userProfile.lastMoodDate = null;
                  }
                }
              } else {
                // Initialize streak data
                this.currentStreak = 0;
                this.lastSuccessfulLogTimeForStreak = null;
                this.highestStreak = 0;
              }
            } catch (error) {
              console.error(
                "Error loading or initializing streak data:",
                error
              );
              this.currentStreak = 0;
              this.lastSuccessfulLogTimeForStreak = null;
              this.highestStreak = 0;
            }
            this.updateStreakDisplay();
          },

          updateStreakDisplay() {
            // Update header streak display
            if (this.currentStreakValueEl && this.highestStreakValueEl) {
              const oldStreakText = this.currentStreakValueEl.textContent;

              this.currentStreakValueEl.textContent = this.currentStreak;
              this.highestStreakValueEl.textContent = this.highestStreak;

              if (
                this.currentStreak > 0 &&
                oldStreakText !== this.currentStreak.toString()
              ) {
                gsap.fromTo(
                  this.currentStreakValueEl,
                  { scale: 1.5, opacity: 0.7, color: "var(--accent-pink)" },
                  {
                    scale: 1,
                    opacity: 1,
                    color: "var(--accent-orange)",
                    duration: 0.6,
                    ease: "back.out(1.7)",
                  }
                );
              }
            }

            // Update profile page streak display if on profile page
            if (this.activePage === "profile") {
              const profileCurrentStreakEl = document.getElementById(
                "profile-current-streak"
              );
              const profileHighestStreakEl = document.getElementById(
                "profile-highest-streak"
              );

              if (profileCurrentStreakEl) {
                profileCurrentStreakEl.textContent = this.currentStreak;
              }
              if (profileHighestStreakEl) {
                profileHighestStreakEl.textContent = this.highestStreak;
              }
            }

            console.log(
              `Streak display updated - Current: ${this.currentStreak}, Highest: ${this.highestStreak}`
            );
          },

          async setupFirebaseInitialData() {
            if (!currentUser) return;

            const moodHistoryPromise = getDocs(
              query(
                collection(this.db, "users", currentUser.uid, "moods"),
                orderBy("timestamp", "desc")
              )
            )
              .then((querySnapshot) => {
                this.moodHistory = [];
                querySnapshot.forEach((doc) => {
                  this.moodHistory.push({ id: doc.id, ...doc.data() });
                });
              })
              .catch((error) => {
                console.error(
                  "Firebase initial moodHistory read failed:",
                  error
                );
                this.moodHistory = [];
              });

            const favoriteQuotesPromise = getDocs(
              collection(this.db, "users", currentUser.uid, "likedQuotes")
            )
              .then((querySnapshot) => {
                this.favoriteQuotes = [];
                querySnapshot.forEach((doc) => {
                  this.favoriteQuotes.push(doc.data());
                });
              })
              .catch((error) => {
                console.error(
                  "Firebase initial favoriteQuotes read failed:",
                  error
                );
                this.favoriteQuotes = [];
              });

            // Load public moods feed
            const publicMoodsPromise = getDocs(
              query(
                collection(this.db, "publicMoods"),
                orderBy("timestamp", "desc"),
                limit(50) // Limit to recent 50 public moods
              )
            )
              .then((querySnapshot) => {
                this.publicMoods = [];
                querySnapshot.forEach((doc) => {
                  this.publicMoods.push({ id: doc.id, ...doc.data() });
                });
              })
              .catch((error) => {
                console.error(
                  "Firebase initial publicMoods read failed:",
                  error
                );
                this.publicMoods = [];
              });

            // Load user's own public moods
            const myPublicMoodsPromise = getDocs(
              query(
                collection(this.db, "publicMoods"),
                where("userId", "==", currentUser.uid),
                orderBy("timestamp", "desc")
              )
            )
              .then((querySnapshot) => {
                this.myPublicMoods = [];
                querySnapshot.forEach((doc) => {
                  this.myPublicMoods.push({ id: doc.id, ...doc.data() });
                });
              })
              .catch((error) => {
                console.error(
                  "Firebase initial myPublicMoods read failed:",
                  error
                );
                this.myPublicMoods = [];
              });

            // Load user preferences for public mood sharing
            const userPreferencesPromise = getDocs(
              collection(this.db, "users", currentUser.uid, "preferences")
            )
              .then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                  const prefs = doc.data();
                  if (prefs.publicMoodSharing !== undefined) {
                    this.publicMoodSharingEnabled = prefs.publicMoodSharing;
                  }
                });
              })
              .catch((error) => {
                console.error(
                  "Firebase initial userPreferences read failed:",
                  error
                );
              });

            return Promise.all([
              moodHistoryPromise,
              favoriteQuotesPromise,
              publicMoodsPromise,
              myPublicMoodsPromise,
              userPreferencesPromise,
            ]);
          },
          setupFirebaseListeners() {
            if (!currentUser) return;

            // Listen to mood history changes
            const moodsQuery = query(
              collection(this.db, "users", currentUser.uid, "moods"),
              orderBy("timestamp", "desc")
            );

            onSnapshot(
              moodsQuery,
              (querySnapshot) => {
                const newMoodHistory = [];
                querySnapshot.forEach((doc) => {
                  newMoodHistory.push({ id: doc.id, ...doc.data() });
                });

                if (
                  JSON.stringify(this.moodHistory) !==
                  JSON.stringify(newMoodHistory)
                ) {
                  this.moodHistory = newMoodHistory;
                  if (this.activePage === "analytics") this.loadAnalyticsPage();
                  if (this.activePage === "history") this.renderHistoryList();
                  if (this.activePage === "profile") this.loadProfilePage();
                }
              },
              (error) => {
                console.error("Firebase moodHistory listener failed:", error);
              }
            );

            // Listen to liked quotes changes
            const likedQuotesQuery = collection(
              this.db,
              "users",
              currentUser.uid,
              "likedQuotes"
            );

            onSnapshot(
              likedQuotesQuery,
              (querySnapshot) => {
                const newFavoriteQuotes = [];
                querySnapshot.forEach((doc) => {
                  newFavoriteQuotes.push(doc.data());
                });

                if (
                  JSON.stringify(this.favoriteQuotes) !==
                  JSON.stringify(newFavoriteQuotes)
                ) {
                  this.favoriteQuotes = newFavoriteQuotes;
                  if (this.activePage === "mood-slider") {
                    this.renderLikedQuotesExplorer();
                    this.loadQuotesForSlider();
                  }
                  if (this.activePage === "history") this.renderHistoryList();
                }
              },
              (error) => {
                console.error(
                  "Firebase favoriteQuotes listener failed:",
                  error
                );
              }
            );

            // Listen to public moods changes
            const publicMoodsQuery = query(
              collection(this.db, "publicMoods"),
              orderBy("timestamp", "desc"),
              limit(50)
            );

            onSnapshot(
              publicMoodsQuery,
              (querySnapshot) => {
                const newPublicMoods = [];
                querySnapshot.forEach((doc) => {
                  newPublicMoods.push({ id: doc.id, ...doc.data() });
                });

                if (
                  JSON.stringify(this.publicMoods) !==
                  JSON.stringify(newPublicMoods)
                ) {
                  this.publicMoods = newPublicMoods;
                  if (this.activePage === "public-mood") {
                    this.loadPublicMoodPage();
                  }
                }
              },
              (error) => {
                console.error("Firebase publicMoods listener failed:", error);
              }
            );

            // Listen to user's own public moods changes
            const myPublicMoodsQuery = query(
              collection(this.db, "publicMoods"),
              where("userId", "==", currentUser.uid),
              orderBy("timestamp", "desc")
            );

            onSnapshot(
              myPublicMoodsQuery,
              (querySnapshot) => {
                const newMyPublicMoods = [];
                querySnapshot.forEach((doc) => {
                  newMyPublicMoods.push({ id: doc.id, ...doc.data() });
                });

                if (
                  JSON.stringify(this.myPublicMoods) !==
                  JSON.stringify(newMyPublicMoods)
                ) {
                  this.myPublicMoods = newMyPublicMoods;
                  if (this.activePage === "public-mood") {
                    this.loadPublicMoodPage();
                  }
                }
              },
              (error) => {
                console.error("Firebase myPublicMoods listener failed:", error);
              }
            );
          },
          encodeQuoteKey(quoteText) {
            try {
              return btoa(unescape(encodeURIComponent(quoteText)));
            } catch (e) {
              console.error("Error encoding quote key:", e, quoteText);
              return quoteText.replace(/[^a-zA-Z0-9]/g, "");
            }
          },
          decodeQuoteKey(encodedKey) {
            try {
              return decodeURIComponent(escape(atob(encodedKey)));
            } catch (e) {
              console.error("Error decoding quote key:", e, encodedKey);
              return encodedKey;
            }
          },
          applyTheme() {
            document.body.classList.toggle("dark-theme", this.isDarkTheme);
            this.updateThemeToggleButton();
            if (p5Instance) {
              p5Instance.loop();
              setTimeout(() => p5Instance.draw(), 10);
            }
            this.updateChartColors();
          },
          updateChartColors() {
            const textColor = getComputedStyle(document.documentElement)
              .getPropertyValue("--text-secondary")
              .trim();
            const gridColor = getComputedStyle(document.documentElement)
              .getPropertyValue("--border-color")
              .trim();
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            Object.values(this.charts).forEach((chart) => {
              if (chart?.options) {
                const scales = chart.options.scales;
                if (scales) {
                  Object.values(scales).forEach((axis) => {
                    if (axis.ticks) axis.ticks.color = textColor;
                    if (axis.grid) axis.grid.color = gridColor;
                    if (axis.title) axis.title.color = textColor;
                  });
                }
                if (chart.options.plugins?.legend?.labels) {
                  chart.options.plugins.legend.labels.color = textColor;
                }
                if (chart.options.plugins?.title?.color) {
                  chart.options.plugins.title.color = textColor;
                }
                chart.update();
              }
            });
          },
          loadData() {
            const theme = localStorage.getItem("moodMirrorTheme");
            this.isDarkTheme = theme === "dark";
            const lastPage = localStorage.getItem("moodMirrorLastPage");
            this.activePage = lastPage || "home";
          },
          saveData() {
            localStorage.setItem(
              "moodMirrorTheme",
              this.isDarkTheme ? "dark" : "light"
            );
            localStorage.setItem("moodMirrorLastPage", this.activePage);
          },
          populateMoodGrid() {
            this.moodGrid.innerHTML = "";
            MOOD_LIST.forEach((mood, index) => {
              const button = document.createElement("button");
              button.classList.add("mood-button");
              button.innerHTML = `<span class="mood-emoji">${mood.emoji}</span><span class="mood-text">${mood.name}</span>`;
              button.addEventListener("click", (e) =>
                this.handleMoodSelection(mood, e.currentTarget)
              );
              this.moodGrid.appendChild(button);
              gsap.fromTo(
                button,
                { opacity: 0, y: 25, scale: 0.9 },
                {
                  opacity: 1,
                  y: 0,
                  scale: 1,
                  duration: 0.5,
                  delay: index * 0.05 + 0.1,
                  ease: "back.out(1.4)",
                }
              );
            });
          },
          populateMoodFilterDropdowns() {
            const moodOptionsHtml = MOOD_LIST.map(
              (m) => `<option value="${m.name}">${m.emoji} ${m.name}</option>`
            ).join("");
            if (this.moodFilterSelect)
              this.moodFilterSelect.innerHTML =
                `<option value="">✨ All Moods</option>` + moodOptionsHtml;
            if (this.historyMoodFilter)
              this.historyMoodFilter.innerHTML =
                `<option value="">✨ All Moods</option>` + moodOptionsHtml;
          },
          handleMoodSelection(mood, buttonElement) {
            this.currentSelectedMood = mood;
            this.modalMoodName.textContent = `Feeling ${mood.emoji} ${mood.name}...`;
            this.moodReasonInput.value = "";
            const relevantQuote = this.getQuoteForMood(mood.name);
            this.displayQuoteInModal(relevantQuote);
            gsap.to(buttonElement, {
              scale: 0.94,
              duration: 0.15,
              yoyo: true,
              repeat: 1,
              ease: "power2.inOut",
            });
            this.modal.style.display = "flex";
            gsap.to(this.modal, {
              opacity: 1,
              duration: 0.35,
              ease: "power1.inOut",
            });
            gsap.fromTo(
              this.modalContent,
              { scale: 0.75, opacity: 0, y: 40 },
              {
                scale: 1,
                opacity: 1,
                y: 0,
                duration: 0.5,
                ease: "back.out(1.5)",
                delay: 0.1,
              }
            );
          },
          getQuoteForMood(moodName, count = 1) {
            const matchingQuotes = ANIME_QUOTES.filter((q) =>
              q.moodMatch.includes(moodName)
            );
            if (matchingQuotes.length === 0) {
              const randomFallbackQuotes = [...ANIME_QUOTES].sort(
                () => 0.5 - Math.random()
              );
              return count === 1
                ? randomFallbackQuotes[0]
                : randomFallbackQuotes.slice(0, count);
            }
            const shuffledMatches = matchingQuotes.sort(
              () => 0.5 - Math.random()
            );
            return count === 1
              ? shuffledMatches[0]
              : shuffledMatches.slice(
                  0,
                  Math.min(count, shuffledMatches.length)
                );
          },
          displayQuoteInModal(quote) {
            if (quote && this.modalQuoteDisplay) {
              this.modalQuoteDisplay.innerHTML = this.createQuoteCardHTML(
                quote,
                false
              );
              this.modalQuoteDisplay.style.display = "block";
              gsap.fromTo(
                this.modalQuoteDisplay,
                { opacity: 0, y: 15 },
                {
                  opacity: 1,
                  y: 0,
                  duration: 0.4,
                  delay: 0.2,
                  ease: "power1.out",
                }
              );
            } else if (this.modalQuoteDisplay) {
              this.modalQuoteDisplay.style.display = "none";
            }
          },
          createQuoteCardHTML(quote, showFullDetails = false) {
            if (!quote) return "";
            let detailsHTML = "";
            if (showFullDetails) {
              detailsHTML = `<div class="quote-details"> ${
                quote.anime
                  ? `<span><strong>Anime:</strong> ${quote.anime}</span>`
                  : ""
              } ${
                quote.character
                  ? `<span><strong>Character:</strong> ${quote.character}</span>`
                  : ""
              } ${
                quote.situation
                  ? `<span><strong>Situation:</strong> ${quote.situation}</span>`
                  : ""
              } ${
                quote.realLifeUse
                  ? `<span><strong>Real-life use:</strong> ${quote.realLifeUse}</span>`
                  : ""
              } </div>`;
            }
            return `<p class="quote-text">"${
              quote.quote
            }"</p> <p class="quote-source">- ${quote.character || "Unknown"}, ${
              quote.anime || "Unknown Source"
            }</p> ${detailsHTML}`;
          },
          async saveCurrentMood() {
            if (!this.currentSelectedMood || !currentUser) return;
            const reason = this.moodReasonInput.value.trim();
            const timestamp = serverTimestamp();
            const timestampISO = new Date().toISOString();

            const displayedQuote = this.modalQuoteDisplay.querySelector(
              ".quote-text"
            )
              ? ANIME_QUOTES.find(
                  (q) =>
                    q.quote ===
                    this.modalQuoteDisplay
                      .querySelector(".quote-text")
                      .textContent.replace(/"/g, "")
                )
              : null;
            const savedQuote =
              displayedQuote ||
              this.getQuoteForMood(this.currentSelectedMood.name);

            const newMoodEntry = {
              mood: this.currentSelectedMood,
              reason: reason,
              timestamp: timestamp,
              timestampISO: timestampISO, // Keep ISO string for compatibility
              userId: currentUser.uid,
              quote: savedQuote || {
                quote: "No quote.",
                character: "",
                anime: "",
              },
            };

            try {
              // Save mood entry to Firestore
              await addDoc(
                collection(this.db, "users", currentUser.uid, "moods"),
                newMoodEntry
              );
              console.log("Mood saved to Firestore:", newMoodEntry);

              // Update user's total mood entries count
              await updateDoc(doc(this.db, "users", currentUser.uid), {
                totalMoodEntries: (userProfile.totalMoodEntries || 0) + 1,
                lastMoodDate: timestamp,
              });

              // Update local userProfile
              userProfile.totalMoodEntries =
                (userProfile.totalMoodEntries || 0) + 1;
              userProfile.lastMoodDate = timestamp;

              // Save to public moods if user has enabled public sharing
              if (this.publicMoodSharingEnabled) {
                await this.savePublicMood(newMoodEntry);
              }

              await this.processStreakAfterMoodSave(timestampISO); // Pass the same timestamp

              gsap
                .timeline()
                .to(this.saveMoodButton, {
                  scale: 1.1,
                  filter: "brightness(1.2)",
                  duration: 0.2,
                  ease: "power2.out",
                })
                .to(this.saveMoodButton, {
                  scale: 1,
                  filter: "brightness(1)",
                  duration: 0.4,
                  ease: "elastic.out(1, 0.7)",
                  delay: 0.1,
                });
              this.closeModal();
            } catch (error) {
              console.error("Error saving mood or processing streak:", error);
            }
          },

          // PUBLIC MOOD METHODS
          async savePublicMood(moodEntry) {
            if (!currentUser || !userProfile) return;

            const publicMoodEntry = {
              mood: moodEntry.mood,
              reason: moodEntry.reason || "", // Include reason if provided
              timestamp: moodEntry.timestamp,
              timestampISO: moodEntry.timestampISO,
              userId: currentUser.uid,
              userDisplayName: userProfile.displayName || "Anonymous User",
              quote: moodEntry.quote,
              isPublic: true,
            };

            try {
              await addDoc(collection(this.db, "publicMoods"), publicMoodEntry);
              console.log("Public mood saved:", publicMoodEntry);
            } catch (error) {
              console.error("Error saving public mood:", error);
            }
          },

          async togglePublicMoodSharing(enabled) {
            if (!currentUser) return;

            this.publicMoodSharingEnabled = enabled;

            try {
              // Save preference to Firestore
              const prefsRef = doc(
                this.db,
                "users",
                currentUser.uid,
                "preferences",
                "publicMoodSharing"
              );
              await setDoc(
                prefsRef,
                {
                  publicMoodSharing: enabled,
                  updatedAt: serverTimestamp(),
                },
                { merge: true }
              );
              console.log("Public mood sharing preference updated:", enabled);
            } catch (error) {
              console.error(
                "Error updating public mood sharing preference:",
                error
              );
            }
          },

          async processStreakAfterMoodSave(newMoodEntryTimestampISO) {
            console.log(
              `Processing streak. New log at: ${newMoodEntryTimestampISO}`
            );
            console.log(
              `Before processing - Current Streak: ${this.currentStreak}, Last Successful Log: ${this.lastSuccessfulLogTimeForStreak}`
            );

            const newLogDate = new Date(newMoodEntryTimestampISO);
            const newLogDateString = newLogDate.toDateString();
            let updatedStreak = this.currentStreak;
            let updatedLastSuccessfulLogTime = newLogDate;

            if (
              this.currentStreak === 0 ||
              !this.lastSuccessfulLogTimeForStreak
            ) {
              // Scenario 1: Starting a new streak (first ever log or streak was reset)
              updatedStreak = 1;
              updatedLastSuccessfulLogTime = newLogDate;
              console.log("Streak started/restarted with first mood log.");
            } else {
              // Scenario 2: Active streak - check calendar days
              const lastLogDate = new Date(this.lastSuccessfulLogTimeForStreak);
              const lastLogDateString = lastLogDate.toDateString();
              const yesterdayDateString = new Date(
                newLogDate.getTime() - 24 * 60 * 60 * 1000
              ).toDateString();

              console.log("Streak calculation:", {
                newLogDate: newLogDateString,
                lastLogDate: lastLogDateString,
                yesterday: yesterdayDateString,
                currentStreak: this.currentStreak,
              });

              if (newLogDateString === lastLogDateString) {
                // Same day - maintain streak, don't increment
                console.log(
                  "Same day log - streak maintained, not incremented."
                );
                // Keep existing values
                updatedStreak = this.currentStreak;
                updatedLastSuccessfulLogTime =
                  this.lastSuccessfulLogTimeForStreak;
              } else if (lastLogDateString === yesterdayDateString) {
                // Last log was yesterday - increment streak
                updatedStreak = this.currentStreak + 1;
                updatedLastSuccessfulLogTime = newLogDate;
                console.log(
                  `Consecutive day log - streak incremented to ${updatedStreak}.`
                );
              } else {
                // Gap in days - reset streak
                updatedStreak = 1;
                updatedLastSuccessfulLogTime = newLogDate;
                console.log("Gap in days - streak reset to 1.");
              }
            }

            this.currentStreak = updatedStreak;
            this.lastSuccessfulLogTimeForStreak = updatedLastSuccessfulLogTime;

            if (this.currentStreak > this.highestStreak) {
              this.highestStreak = this.currentStreak;
              console.log(`New highest streak: ${this.highestStreak}`);
            }

            console.log(
              `After processing - Current Streak: ${this.currentStreak}, Last Successful Log: ${this.lastSuccessfulLogTimeForStreak}, Highest: ${this.highestStreak}`
            );

            try {
              // Ensure we have a proper Date object for Firestore
              const lastMoodDateForFirestore =
                this.lastSuccessfulLogTimeForStreak instanceof Date
                  ? this.lastSuccessfulLogTimeForStreak
                  : new Date(this.lastSuccessfulLogTimeForStreak);

              // Update user profile with streak information
              await updateDoc(doc(this.db, "users", currentUser.uid), {
                currentStreak: this.currentStreak,
                highestStreak: this.highestStreak,
                lastMoodDate: Timestamp.fromDate(lastMoodDateForFirestore),
              });

              // Update local userProfile
              userProfile.currentStreak = this.currentStreak;
              userProfile.highestStreak = this.highestStreak;
              userProfile.lastMoodDate = Timestamp.fromDate(
                lastMoodDateForFirestore
              );

              console.log("Streak info successfully updated in Firestore.");
            } catch (error) {
              console.error("Error saving streak info to Firestore:", error);
            }
            this.updateStreakDisplay();
          },

          // STREAK TESTING: Debug function for testing streak logic
          testStreakLogic() {
            console.log("=== STREAK TESTING ===");
            console.log("Current app state:");
            console.log("- currentStreak:", this.currentStreak);
            console.log("- highestStreak:", this.highestStreak);
            console.log(
              "- lastSuccessfulLogTimeForStreak:",
              this.lastSuccessfulLogTimeForStreak
            );
            console.log(
              "- userProfile.currentStreak:",
              userProfile?.currentStreak
            );
            console.log(
              "- userProfile.highestStreak:",
              userProfile?.highestStreak
            );
            console.log(
              "- userProfile.lastMoodDate:",
              userProfile?.lastMoodDate
            );

            // Test date calculations
            const today = new Date();
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            console.log("Date calculations:");
            console.log("- Today:", today.toDateString());
            console.log("- Yesterday:", yesterday.toDateString());

            if (this.lastSuccessfulLogTimeForStreak) {
              const lastLogDate = new Date(this.lastSuccessfulLogTimeForStreak);
              console.log("- Last log date:", lastLogDate.toDateString());
              console.log(
                "- Is last log today?",
                lastLogDate.toDateString() === today.toDateString()
              );
              console.log(
                "- Is last log yesterday?",
                lastLogDate.toDateString() === yesterday.toDateString()
              );
            }

            console.log("=== END STREAK TESTING ===");
          },

          closeModal() {
            gsap.to(this.modalContent, {
              scale: 0.8,
              opacity: 0,
              y: 50,
              duration: 0.4,
              ease: "power2.in",
              onComplete: () => {
                if (this.modal) this.modal.style.display = "none";
              },
            });
            gsap.to(this.modal, { opacity: 0, duration: 0.3, delay: 0.1 });
          },
          setupEventListeners() {
            this.saveMoodButton.addEventListener("click", () =>
              this.saveCurrentMood()
            );
            this.closeModalButton.addEventListener("click", () =>
              this.closeModal()
            );
            this.navButtons.forEach((button) => {
              button.addEventListener("click", () => {
                this.navigateToPage(button.dataset.page);
              });
            });
            if (this.moodFilterSelect)
              this.moodFilterSelect.addEventListener("change", () =>
                this.loadQuotesForSlider()
              );
            if (this.quoteModeToggle)
              this.quoteModeToggle.addEventListener("click", () =>
                this.toggleQuoteSliderMode()
              );
            if (this.themeToggle)
              this.themeToggle.addEventListener("click", () =>
                this.toggleTheme()
              );
            if (this.historySearchTerm)
              this.historySearchTerm.addEventListener("input", () =>
                this.renderHistoryList()
              );
            if (this.historyMoodFilter)
              this.historyMoodFilter.addEventListener("change", () =>
                this.renderHistoryList()
              );
            if (this.historyDateFilter)
              this.historyDateFilter.addEventListener("change", () =>
                this.renderHistoryList()
              );
            if (this.clearHistoryFiltersBtn)
              this.clearHistoryFiltersBtn.addEventListener("click", () => {
                this.historySearchTerm.value = "";
                this.historyMoodFilter.value = "";
                this.historyDateFilter.value = "";
                this.renderHistoryList();
              });
            this.modal.addEventListener("click", (e) => {
              if (e.target === this.modal) this.closeModal();
            });
            this.closeQuoteViewButton.addEventListener("click", () =>
              this.closeQuoteViewModal()
            );
            this.quoteViewModal.addEventListener("click", (e) => {
              if (e.target === this.quoteViewModal) this.closeQuoteViewModal();
            });
            if (this.infoButton)
              this.infoButton.addEventListener("click", () =>
                this.openInfoModal()
              );
            if (this.closeInfoModalButton)
              this.closeInfoModalButton.addEventListener("click", () =>
                this.closeInfoModal()
              );
            if (this.infoModal)
              this.infoModal.addEventListener("click", (e) => {
                if (e.target === this.infoModal) this.closeInfoModal();
              });
            if (this.quoteSliderResults) {
              this.quoteSliderResults.addEventListener(
                "click",
                this.handleQuoteCardClick.bind(this)
              );
            }
            if (this.likedQuotesExplorerList) {
              this.likedQuotesExplorerList.addEventListener(
                "click",
                this.handleQuoteCardClick.bind(this)
              );
            }
            if (this.historyList) {
              this.historyList.addEventListener(
                "click",
                this.handleHistoryListClick.bind(this)
              );
            }

            // Update public mood sharing toggle state
            this.updatePublicMoodSharingToggleUI();

            // Profile page event listeners
            const updateDisplayNameBtn = document.getElementById(
              "update-display-name-btn"
            );
            const deleteAccountBtn =
              document.getElementById("delete-account-btn");
            const performanceToggle =
              document.getElementById("performance-toggle");
            const publicMoodSharingToggle = document.getElementById(
              "public-mood-sharing-toggle"
            );

            if (updateDisplayNameBtn) {
              updateDisplayNameBtn.addEventListener("click", () =>
                this.updateDisplayName()
              );
            }
            if (deleteAccountBtn) {
              deleteAccountBtn.addEventListener("click", () =>
                this.deleteAccount()
              );
            }
            if (performanceToggle) {
              performanceToggle.addEventListener("click", () =>
                this.togglePerformanceMode()
              );
            }
            if (publicMoodSharingToggle) {
              publicMoodSharingToggle.addEventListener("click", () =>
                this.togglePublicMoodSharingUI()
              );
            }
          },
          navigateToPage(pageId, isInitialLoad = false) {
            if (!pageId) return;
            if (pageId === this.activePage && !isInitialLoad) return;
            const oldPageId = this.activePage;
            const oldPage = document.getElementById(`${oldPageId}-page`);
            const newPage = document.getElementById(`${pageId}-page`);
            if (!newPage) {
              console.error(`Page with id "${pageId}-page" not found.`);
              return;
            }
            this.activePage = pageId;
            this.saveData();
            this.navButtons.forEach((btn) => {
              btn.classList.toggle("active-nav", btn.dataset.page === pageId);
            });
            const tl = gsap.timeline({
              defaults: { duration: 0.4, ease: "power2.inOut" },
              onComplete: () => {
                if (pageId === "analytics") this.loadAnalyticsPage();
                if (pageId === "mood-slider") {
                  this.renderLikedQuotesExplorer();
                  this.loadQuotesForSlider();
                }
                if (pageId === "public-mood") this.loadPublicMoodPage();
                if (pageId === "history") this.renderHistoryList();
                if (pageId === "profile") this.loadProfilePage();
              },
            });
            if (oldPage && oldPage !== newPage && !isInitialLoad) {
              tl.to(oldPage, { opacity: 0, y: -15 });
              tl.set(oldPage, { visibility: "hidden", display: "none" });
              tl.set(newPage, {
                visibility: "visible",
                display: "block",
                opacity: 0,
                y: 15,
              });
              tl.to(newPage, { opacity: 1, y: 0 }, ">-0.2");
            } else {
              gsap.set(this.pages, {
                visibility: "hidden",
                display: "none",
                opacity: 0,
              });
              gsap.set(newPage, {
                visibility: "visible",
                display: "block",
                opacity: 1,
                y: 0,
              });
              if (isInitialLoad) {
                if (pageId === "analytics") this.loadAnalyticsPage();
                if (pageId === "mood-slider") {
                  this.renderLikedQuotesExplorer();
                  this.loadQuotesForSlider();
                }
                if (pageId === "public-mood") this.loadPublicMoodPage();
                if (pageId === "history") this.renderHistoryList();
                if (pageId === "profile") this.loadProfilePage();
              }
            }
          },

          // Mood Heatmap functions
          generateMoodHeatmap() {
            const heatmapContainer = document.getElementById("mood-heatmap");
            if (!heatmapContainer) return;

            // Clear existing content
            heatmapContainer.innerHTML = "";

            // Generate last 365 days
            const today = new Date();
            const oneYearAgo = new Date(today);
            oneYearAgo.setDate(today.getDate() - 364);

            // Create month labels
            const monthsContainer = document.createElement("div");
            monthsContainer.className = "heatmap-months";
            const months = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];
            months.forEach((month) => {
              const monthDiv = document.createElement("div");
              monthDiv.textContent = month;
              monthsContainer.appendChild(monthDiv);
            });

            // Create wrapper for days and grid
            const wrapperDiv = document.createElement("div");
            wrapperDiv.className = "heatmap-wrapper";

            // Create day labels
            const daysContainer = document.createElement("div");
            daysContainer.className = "heatmap-days";
            const dayLabels = ["", "Mon", "", "Wed", "", "Fri", ""];
            dayLabels.forEach((day) => {
              const dayDiv = document.createElement("div");
              dayDiv.textContent = day;
              daysContainer.appendChild(dayDiv);
            });

            // Create grid container
            const gridContainer = document.createElement("div");
            gridContainer.className = "heatmap-grid";

            // Generate mood data map for quick lookup
            const moodDataMap = new Map();
            this.moodHistory.forEach((entry) => {
              const date = new Date(entry.timestamp).toDateString();
              if (!moodDataMap.has(date)) {
                moodDataMap.set(date, []);
              }
              moodDataMap.get(date).push(entry);
            });

            // Generate 365 days
            for (let i = 0; i < 365; i++) {
              const currentDate = new Date(oneYearAgo);
              currentDate.setDate(oneYearAgo.getDate() + i);

              const dayDiv = document.createElement("div");
              dayDiv.className = "heatmap-day";

              const dateString = currentDate.toDateString();
              const dayMoods = moodDataMap.get(dateString) || [];

              // Calculate intensity based on number of mood entries
              const intensity = Math.min(dayMoods.length, 4);
              if (intensity > 0) {
                dayDiv.classList.add(`level-${intensity}`);
              }

              // Add tooltip functionality
              dayDiv.addEventListener("mouseenter", (e) => {
                this.showHeatmapTooltip(e, currentDate, dayMoods);
              });

              dayDiv.addEventListener("mouseleave", () => {
                this.hideHeatmapTooltip();
              });

              gridContainer.appendChild(dayDiv);
            }

            wrapperDiv.appendChild(daysContainer);
            wrapperDiv.appendChild(gridContainer);

            heatmapContainer.appendChild(monthsContainer);
            heatmapContainer.appendChild(wrapperDiv);
          },

          showHeatmapTooltip(event, date, moods) {
            // Remove existing tooltip
            this.hideHeatmapTooltip();

            const tooltip = document.createElement("div");
            tooltip.className = "heatmap-tooltip";
            tooltip.id = "heatmap-tooltip";

            const formattedDate = date.toLocaleDateString("en-US", {
              weekday: "short",
              month: "short",
              day: "numeric",
              year: "numeric",
            });

            let content = `<strong>${formattedDate}</strong><br>`;

            if (moods.length === 0) {
              content += "No mood entries";
            } else {
              content += `${moods.length} mood ${
                moods.length === 1 ? "entry" : "entries"
              }`;
              if (moods.length <= 3) {
                content += "<br>";
                moods.forEach((mood) => {
                  content += `${mood.mood} `;
                });
              }
            }

            tooltip.innerHTML = content;

            // Position tooltip
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = rect.left + rect.width / 2 + "px";
            tooltip.style.top = rect.top - 10 + "px";
            tooltip.style.transform = "translateX(-50%) translateY(-100%)";

            document.body.appendChild(tooltip);
          },

          hideHeatmapTooltip() {
            const existingTooltip = document.getElementById("heatmap-tooltip");
            if (existingTooltip) {
              existingTooltip.remove();
            }
          },

          // Mood Calendar functions
          initializeCalendar() {
            this.currentCalendarDate = new Date();
            this.calendarViewMode = "month"; // 'month' or 'week'
            this.selectedCalendarDate = null;

            // Setup event listeners
            const monthViewBtn = document.getElementById("month-view-btn");
            const weekViewBtn = document.getElementById("week-view-btn");
            const calendarPrev = document.getElementById("calendar-prev");
            const calendarNext = document.getElementById("calendar-next");
            const calendarToday = document.getElementById("calendar-today");

            if (monthViewBtn) {
              monthViewBtn.addEventListener("click", () =>
                this.switchCalendarView("month")
              );
            }
            if (weekViewBtn) {
              weekViewBtn.addEventListener("click", () =>
                this.switchCalendarView("week")
              );
            }
            if (calendarPrev) {
              calendarPrev.addEventListener("click", () =>
                this.navigateCalendar(-1)
              );
            }
            if (calendarNext) {
              calendarNext.addEventListener("click", () =>
                this.navigateCalendar(1)
              );
            }
            if (calendarToday) {
              calendarToday.addEventListener("click", () => this.goToToday());
            }
          },

          switchCalendarView(mode) {
            this.calendarViewMode = mode;

            // Update button states
            const monthBtn = document.getElementById("month-view-btn");
            const weekBtn = document.getElementById("week-view-btn");

            if (monthBtn && weekBtn) {
              monthBtn.classList.toggle("active", mode === "month");
              weekBtn.classList.toggle("active", mode === "week");

              if (mode === "month") {
                monthBtn.style.background = "var(--accent-blue)";
                monthBtn.style.color = "white";
                weekBtn.style.background = "transparent";
                weekBtn.style.color = "var(--text-secondary)";
              } else {
                weekBtn.style.background = "var(--accent-blue)";
                weekBtn.style.color = "white";
                monthBtn.style.background = "transparent";
                monthBtn.style.color = "var(--text-secondary)";
              }
            }

            this.renderCalendar();
          },

          navigateCalendar(direction) {
            if (this.calendarViewMode === "month") {
              this.currentCalendarDate.setMonth(
                this.currentCalendarDate.getMonth() + direction
              );
            } else {
              this.currentCalendarDate.setDate(
                this.currentCalendarDate.getDate() + direction * 7
              );
            }
            this.renderCalendar();
          },

          goToToday() {
            this.currentCalendarDate = new Date();
            this.renderCalendar();
          },

          renderCalendar() {
            const calendarContainer = document.getElementById("mood-calendar");
            const currentPeriodSpan = document.getElementById(
              "calendar-current-period"
            );

            if (!calendarContainer || !currentPeriodSpan) return;

            if (this.calendarViewMode === "month") {
              this.renderMonthView(calendarContainer, currentPeriodSpan);
            } else {
              this.renderWeekView(calendarContainer, currentPeriodSpan);
            }
          },

          renderMonthView(container, periodSpan) {
            const year = this.currentCalendarDate.getFullYear();
            const month = this.currentCalendarDate.getMonth();

            // Update period display
            periodSpan.textContent = new Date(year, month).toLocaleDateString(
              "en-US",
              {
                month: "long",
                year: "numeric",
              }
            );

            // Clear container
            container.innerHTML = "";

            // Create header
            const header = document.createElement("div");
            header.className = "calendar-header";
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            dayNames.forEach((day) => {
              const dayDiv = document.createElement("div");
              dayDiv.textContent = day;
              header.appendChild(dayDiv);
            });

            // Create grid
            const grid = document.createElement("div");
            grid.className = "calendar-grid";

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            // Generate mood data map
            const moodDataMap = new Map();
            this.moodHistory.forEach((entry) => {
              const date = new Date(entry.timestamp).toDateString();
              if (!moodDataMap.has(date)) {
                moodDataMap.set(date, []);
              }
              moodDataMap.get(date).push(entry);
            });

            // Generate 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
              const currentDate = new Date(startDate);
              currentDate.setDate(startDate.getDate() + i);

              const dayDiv = document.createElement("div");
              dayDiv.className = "calendar-day";

              const isCurrentMonth = currentDate.getMonth() === month;
              const isToday =
                currentDate.toDateString() === new Date().toDateString();
              const dateString = currentDate.toDateString();
              const dayMoods = moodDataMap.get(dateString) || [];

              if (!isCurrentMonth) {
                dayDiv.classList.add("other-month");
              }
              if (isToday) {
                dayDiv.classList.add("today");
              }
              if (dayMoods.length > 0) {
                dayDiv.classList.add("has-moods");
              }

              // Day number
              const dayNumber = document.createElement("div");
              dayNumber.className = "calendar-day-number";
              dayNumber.textContent = currentDate.getDate();

              // Mood emojis
              const moodsContainer = document.createElement("div");
              moodsContainer.className = "calendar-day-moods";

              if (dayMoods.length > 0) {
                if (dayMoods.length <= 4) {
                  dayMoods.forEach((mood) => {
                    const emojiSpan = document.createElement("span");
                    emojiSpan.className = "calendar-mood-emoji";
                    emojiSpan.textContent = mood.mood.emoji;
                    moodsContainer.appendChild(emojiSpan);
                  });
                } else {
                  const countBadge = document.createElement("div");
                  countBadge.className = "calendar-mood-count";
                  countBadge.textContent = dayMoods.length;
                  dayDiv.appendChild(countBadge);
                }
              }

              dayDiv.appendChild(dayNumber);
              dayDiv.appendChild(moodsContainer);

              // Click handler
              dayDiv.addEventListener("click", () => {
                this.selectCalendarDate(currentDate, dayMoods);
              });

              grid.appendChild(dayDiv);
            }

            container.appendChild(header);
            container.appendChild(grid);
          },

          renderWeekView(container, periodSpan) {
            const currentDate = new Date(this.currentCalendarDate);
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            // Update period display
            periodSpan.textContent = `${startOfWeek.toLocaleDateString(
              "en-US",
              {
                month: "short",
                day: "numeric",
              }
            )} - ${endOfWeek.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            })}`;

            // Clear container
            container.innerHTML = "";

            // Create grid
            const grid = document.createElement("div");
            grid.className = "week-grid";

            // Generate mood data map
            const moodDataMap = new Map();
            this.moodHistory.forEach((entry) => {
              const date = new Date(entry.timestamp).toDateString();
              if (!moodDataMap.has(date)) {
                moodDataMap.set(date, []);
              }
              moodDataMap.get(date).push(entry);
            });

            // Generate 7 days
            const dayNames = [
              "Sunday",
              "Monday",
              "Tuesday",
              "Wednesday",
              "Thursday",
              "Friday",
              "Saturday",
            ];

            for (let i = 0; i < 7; i++) {
              const currentDay = new Date(startOfWeek);
              currentDay.setDate(startOfWeek.getDate() + i);

              const dayDiv = document.createElement("div");
              dayDiv.className = "week-day";

              const isToday =
                currentDay.toDateString() === new Date().toDateString();
              const dateString = currentDay.toDateString();
              const dayMoods = moodDataMap.get(dateString) || [];

              if (isToday) {
                dayDiv.classList.add("today");
              }

              // Day header
              const header = document.createElement("div");
              header.className = "week-day-header";
              header.innerHTML = `
                <span>${dayNames[i]}</span>
                <span>${currentDay.getDate()}</span>
              `;

              // Moods container
              const moodsContainer = document.createElement("div");
              moodsContainer.className = "week-day-moods";

              if (dayMoods.length > 0) {
                dayMoods.forEach((mood) => {
                  const moodItem = document.createElement("div");
                  moodItem.className = "week-mood-item";

                  const time = new Date(mood.timestamp).toLocaleTimeString(
                    "en-US",
                    {
                      hour: "numeric",
                      minute: "2-digit",
                      hour12: true,
                    }
                  );

                  moodItem.innerHTML = `
                    <span>${mood.mood.emoji}</span>
                    <span>${mood.mood.name}</span>
                    <span style="margin-left: auto; font-size: 0.7rem; opacity: 0.7;">${time}</span>
                  `;
                  moodsContainer.appendChild(moodItem);
                });
              } else {
                const emptyMessage = document.createElement("div");
                emptyMessage.style.cssText =
                  "text-align: center; color: var(--text-secondary); font-size: 0.8rem; opacity: 0.6; margin-top: 1rem;";
                emptyMessage.textContent = "No moods";
                moodsContainer.appendChild(emptyMessage);
              }

              dayDiv.appendChild(header);
              dayDiv.appendChild(moodsContainer);

              // Click handler
              dayDiv.addEventListener("click", () => {
                this.selectCalendarDate(currentDay, dayMoods);
              });

              grid.appendChild(dayDiv);
            }

            container.appendChild(grid);
          },

          selectCalendarDate(date, moods) {
            this.selectedCalendarDate = date;

            // Update selected state
            document
              .querySelectorAll(".calendar-day, .week-day")
              .forEach((day) => {
                day.classList.remove("selected");
              });

            // Find and highlight selected day
            const allDays = document.querySelectorAll(
              ".calendar-day, .week-day"
            );
            allDays.forEach((day) => {
              if (day.dataset.date === date.toDateString()) {
                day.classList.add("selected");
              }
            });

            // Show mood details
            this.showCalendarMoodDetails(date, moods);
          },

          showCalendarMoodDetails(date, moods) {
            const detailsContainer = document.getElementById(
              "calendar-mood-details"
            );
            const titleSpan = document.getElementById("selected-date-title");
            const moodsContainer = document.getElementById(
              "selected-date-moods"
            );

            if (!detailsContainer || !titleSpan || !moodsContainer) return;

            const formattedDate = date.toLocaleDateString("en-US", {
              weekday: "long",
              month: "long",
              day: "numeric",
              year: "numeric",
            });

            titleSpan.textContent = formattedDate;
            moodsContainer.innerHTML = "";

            if (moods.length === 0) {
              moodsContainer.innerHTML =
                '<p style="color: var(--text-secondary); font-style: italic;">No mood entries for this date.</p>';
            } else {
              moods.forEach((mood) => {
                const moodDiv = document.createElement("div");
                moodDiv.style.cssText =
                  "display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-main); border-radius: 6px; margin-bottom: 0.5rem;";

                const time = new Date(mood.timestamp).toLocaleTimeString(
                  "en-US",
                  {
                    hour: "numeric",
                    minute: "2-digit",
                    hour12: true,
                  }
                );

                moodDiv.innerHTML = `
                  <span style="font-size: 1.2rem;">${mood.mood.emoji}</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-primary);">${
                      mood.mood.name
                    }</div>
                    ${
                      mood.reason
                        ? `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">${mood.reason}</div>`
                        : ""
                    }
                  </div>
                  <span style="font-size: 0.8rem; color: var(--text-secondary);">${time}</span>
                `;

                moodsContainer.appendChild(moodDiv);
              });
            }

            detailsContainer.style.display = "block";

            // Smooth scroll to details
            detailsContainer.scrollIntoView({
              behavior: "smooth",
              block: "nearest",
            });
          },

          loadAnalyticsPage() {
            setTimeout(() => {
              Object.values(this.charts).forEach((chart) => {
                if (chart && typeof chart.destroy === "function")
                  chart.destroy();
              });
              this.charts = {};
              const hasData = this.moodHistory && this.moodHistory.length > 0;
              const freqCtx = this.moodFrequencyChartCtx;
              const distCtx = this.moodDistributionChartCtx;
              const topCtx = this.topMoodsChartCtx;

              // Update analytics stats
              this.updateAnalyticsStats();

              if (!hasData) {
                if (this.reasonSnippetsContainer)
                  this.reasonSnippetsContainer.innerHTML =
                    "<h3 class='text-center' style='color:var(--text-secondary);'>💬 Recent Reflections</h3><p class='text-center' style='color:var(--text-secondary);'>No mood data yet. Select a mood on the Home page to get started!</p>";
                if (freqCtx?.canvas)
                  this.clearChart(freqCtx.canvas, "Mood Frequency");
                if (distCtx?.canvas)
                  this.clearChart(distCtx.canvas, "Overall Distribution");
                if (topCtx?.canvas)
                  this.clearChart(topCtx.canvas, "Top 5 Moods");
              } else {
                this.generateMoodHeatmap(); // Generate heatmap first
                this.initializeCalendar(); // Initialize calendar
                this.renderCalendar(); // Render calendar
                if (freqCtx) this.renderMoodFrequencyChart();
                if (distCtx) this.renderMoodDistributionChart();
                if (topCtx) this.renderTopMoodsChart();
                this.renderReasonSnippets();
                this.updateMoodInsights();
                this.updateChartColors();
                gsap.fromTo(
                  "#analytics-page .stat-card",
                  { opacity: 0, y: 20, scale: 0.95 },
                  {
                    opacity: 1,
                    y: 0,
                    scale: 1,
                    stagger: 0.1,
                    duration: 0.5,
                    ease: "back.out(1.2)",
                    delay: 0.1,
                  }
                );
                gsap.fromTo(
                  "#analytics-page .chart-container",
                  { opacity: 0, y: 30, scale: 0.95 },
                  {
                    opacity: 1,
                    y: 0,
                    scale: 1,
                    stagger: 0.1,
                    duration: 0.6,
                    ease: "back.out(1.2)",
                    delay: 0.3,
                  }
                );
                gsap.fromTo(
                  "#analytics-page .insight-card",
                  { opacity: 0, x: -25 },
                  {
                    opacity: 1,
                    x: 0,
                    stagger: 0.1,
                    duration: 0.5,
                    ease: "power2.out",
                    delay: 0.5,
                  }
                );
                gsap.fromTo(
                  "#reason-snippets-container .reason-snippet",
                  { opacity: 0, x: -25 },
                  {
                    opacity: 1,
                    x: 0,
                    stagger: 0.08,
                    duration: 0.5,
                    ease: "power2.out",
                    delay: 0.7,
                  }
                );
              }
            }, 50);
          },
          clearChart(canvas, title = "") {
            if (!canvas) return;
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = getComputedStyle(
              document.documentElement
            ).getPropertyValue("--text-secondary");
            ctx.font = "16px " + getComputedStyle(document.body).fontFamily;
            ctx.fillText(
              "No data available",
              canvas.width / 2,
              canvas.height / 2
            );
            if (title) {
              ctx.fillStyle = getComputedStyle(
                document.documentElement
              ).getPropertyValue("--accent-orange");
              ctx.font =
                "600 1.2em " + getComputedStyle(document.body).fontFamily;
              ctx.fillText(title, canvas.width / 2, canvas.height * 0.15);
            }
            ctx.restore();
          },
          renderMoodFrequencyChart() {
            if (!this.moodFrequencyChartCtx) return;
            if (this.moodHistory.length === 0) {
              this.clearChart(
                this.moodFrequencyChartCtx.canvas,
                "Mood Frequency"
              );
              return;
            }
            const dailyMoodCounts = {};
            const allMoods = new Set();
            this.moodHistory.forEach((entry) => {
              // Handle both Firestore timestamp and ISO string formats
              let entryDateObj;
              if (entry.timestamp && entry.timestamp.toDate) {
                entryDateObj = entry.timestamp.toDate();
              } else if (entry.timestampISO) {
                entryDateObj = new Date(entry.timestampISO);
              } else {
                entryDateObj = new Date(entry.timestamp);
              }

              const date = entryDateObj.toISOString().split("T")[0];
              if (!dailyMoodCounts[date]) dailyMoodCounts[date] = {};
              const moodName = entry.mood.name;
              dailyMoodCounts[date][moodName] =
                (dailyMoodCounts[date][moodName] || 0) + 1;
              allMoods.add(moodName);
            });
            const sortedDates = Object.keys(dailyMoodCounts).sort();
            const moodColors = this.generateConsistentMoodColors(allMoods);
            const datasets = Array.from(allMoods).map((moodName) => {
              const moodData = sortedDates.map(
                (date) => dailyMoodCounts[date][moodName] || 0
              );
              return {
                label: moodName,
                data: moodData,
                borderColor: moodColors[moodName],
                backgroundColor: moodColors[moodName] + "33",
                tension: 0.3,
                fill: false,
                pointRadius: 3,
                pointHoverRadius: 6,
                borderWidth: 2,
              };
            });
            if (this.charts.frequency) this.charts.frequency.destroy();
            if (datasets.length === 0 || sortedDates.length === 0) {
              this.clearChart(
                this.moodFrequencyChartCtx.canvas,
                "Mood Frequency"
              );
              return;
            }
            this.charts.frequency = new Chart(this.moodFrequencyChartCtx, {
              type: "line",
              data: { labels: sortedDates, datasets: datasets },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                scales: {
                  y: {
                    beginAtZero: true,
                    suggestedMax: 5,
                    grid: { drawBorder: false },
                  },
                  x: { grid: { display: false } },
                },
                plugins: {
                  legend: {
                    position: "bottom",
                    labels: { boxWidth: 12, padding: 15, font: { size: 11 } },
                  },
                },
              },
            });
          },
          renderMoodDistributionChart() {
            if (!this.moodDistributionChartCtx) return;
            if (this.moodHistory.length === 0) {
              this.clearChart(
                this.moodDistributionChartCtx.canvas,
                "Overall Distribution"
              );
              return;
            }
            const moodCounts = {};
            this.moodHistory.forEach((entry) => {
              moodCounts[entry.mood.name] =
                (moodCounts[entry.mood.name] || 0) + 1;
            });
            const labels = Object.keys(moodCounts);
            const data = Object.values(moodCounts);
            const moodColors = this.generateConsistentMoodColors(
              new Set(labels)
            );
            if (this.charts.distribution) this.charts.distribution.destroy();
            if (labels.length === 0) {
              this.clearChart(
                this.moodDistributionChartCtx.canvas,
                "Overall Distribution"
              );
              return;
            }
            this.charts.distribution = new Chart(
              this.moodDistributionChartCtx,
              {
                type: "doughnut",
                data: {
                  labels: labels,
                  datasets: [
                    {
                      label: "Mood Distribution",
                      data: data,
                      backgroundColor: labels.map((label) => moodColors[label]),
                      hoverOffset: 10,
                      borderWidth: 0,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  cutout: "65%",
                  plugins: {
                    legend: {
                      display: true,
                      position: "bottom",
                      labels: { boxWidth: 12, padding: 15, font: { size: 11 } },
                    },
                  },
                },
              }
            );
          },
          renderTopMoodsChart() {
            if (!this.topMoodsChartCtx) return;
            if (this.moodHistory.length === 0) {
              this.clearChart(this.topMoodsChartCtx.canvas, "Top 5 Moods");
              return;
            }
            const moodCounts = {};
            this.moodHistory.forEach((entry) => {
              moodCounts[entry.mood.name] =
                (moodCounts[entry.mood.name] || 0) + 1;
            });
            const sortedMoods = Object.entries(moodCounts)
              .sort(([, a], [, b]) => b - a)
              .slice(0, 5);
            const labels = sortedMoods.map((entry) => entry[0]);
            const data = sortedMoods.map((entry) => entry[1]);
            const moodColors = this.generateConsistentMoodColors(
              new Set(labels)
            );
            if (this.charts.topMoods) this.charts.topMoods.destroy();
            if (labels.length === 0) {
              this.clearChart(this.topMoodsChartCtx.canvas, "Top 5 Moods");
              return;
            }
            this.charts.topMoods = new Chart(this.topMoodsChartCtx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: "Count",
                    data: data,
                    backgroundColor: labels.map(
                      (label) => moodColors[label] + "CC"
                    ),
                    borderColor: labels.map((label) => moodColors[label]),
                    borderWidth: 1,
                    borderRadius: 6,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: "y",
                scales: {
                  y: { grid: { display: false } },
                  x: {
                    beginAtZero: true,
                    grid: { drawBorder: false },
                    ticks: { stepSize: 1 },
                  },
                },
                plugins: { legend: { display: false } },
              },
            });
          },
          generateConsistentMoodColors(moodNamesSet) {
            const colors = {};
            let hue = 0;
            const hueIncrement = 360 / (moodNamesSet.size || 10);
            Array.from(moodNamesSet)
              .sort()
              .forEach((name) => {
                const saturation = this.isDarkTheme ? 75 : 70;
                const lightness = this.isDarkTheme ? 70 : 60;
                colors[name] = `hsl(${
                  hue % 360
                }, ${saturation}%, ${lightness}%)`;
                hue += hueIncrement * 1.618;
              });
            return colors;
          },
          renderReasonSnippets() {
            if (!this.reasonSnippetsContainer) return;
            const recentEntries = this.moodHistory.slice(-5).reverse();
            this.reasonSnippetsContainer.innerHTML =
              "<h3 class='text-center' style='color:var(--text-secondary); margin-bottom: 15px;'>Recent Reflections</h3>";
            if (recentEntries.length === 0) {
              this.reasonSnippetsContainer.innerHTML +=
                "<p class='text-center' style='color:var(--text-secondary);'>No reflections recorded recently.</p>";
              return;
            }
            recentEntries.forEach((entry, index) => {
              if (entry.reason) {
                const snippetDiv = document.createElement("div");
                snippetDiv.classList.add("reason-snippet");
                // Handle timestamp display for both formats
                let displayDate;
                if (entry.timestamp && entry.timestamp.toDate) {
                  displayDate = entry.timestamp.toDate().toLocaleDateString();
                } else if (entry.timestampISO) {
                  displayDate = new Date(
                    entry.timestampISO
                  ).toLocaleDateString();
                } else {
                  displayDate = new Date(entry.timestamp).toLocaleDateString();
                }

                snippetDiv.innerHTML = `<span class="mood-emoji-small">${
                  entry.mood.emoji
                }</span> ${entry.reason.substring(0, 100)}${
                  entry.reason.length > 100 ? "..." : ""
                } <span class="reason-date">${displayDate}</span>`;
                this.reasonSnippetsContainer.appendChild(snippetDiv);
              }
            });
          },
          renderLikedQuotesExplorer() {
            if (
              !this.likedQuotesExplorerList ||
              !this.likedQuotesExplorerSection
            )
              return;
            this.likedQuotesExplorerList.innerHTML = "";

            // favoriteQuotes now contains objects with quote, character, anime properties
            const likedQuotesObjects = this.favoriteQuotes
              .map((favQuote) => {
                // If favQuote is a string (old format), find the full quote object
                if (typeof favQuote === "string") {
                  return ANIME_QUOTES.find((q) => q.quote === favQuote);
                }
                // If favQuote is already an object (new format), find the full quote object for additional data
                return (
                  ANIME_QUOTES.find((q) => q.quote === favQuote.quote) ||
                  favQuote
                );
              })
              .filter((quote) => quote);

            if (likedQuotesObjects.length === 0) {
              this.likedQuotesExplorerSection.style.display = "none";
              return;
            }
            this.likedQuotesExplorerSection.style.display = "block";
            likedQuotesObjects.forEach((quote, index) => {
              const card = document.createElement("div");
              card.classList.add("quote-card");
              card.dataset.quoteText = quote.quote;
              const isLiked = true;
              const likeButtonHTML = `<button class="like-btn liked" data-quote="${quote.quote}" title="Unlike Quote">❤️</button>`;
              card.innerHTML =
                this.createQuoteCardHTML(quote, true) + likeButtonHTML;
              this.likedQuotesExplorerList.appendChild(card);
              gsap.fromTo(
                card,
                { opacity: 0, y: 20, scale: 0.98 },
                {
                  opacity: 1,
                  y: 0,
                  scale: 1,
                  duration: 0.4,
                  delay: index * 0.05,
                  ease: "power1.out",
                }
              );
            });
          },
          loadQuotesForSlider() {
            if (!this.quoteSliderResults) return;
            this.quoteSliderResults.innerHTML = "";
            let quotesToShow = [];
            const selectedMood = this.moodFilterSelect.value;
            if (this.quoteSliderMode === "random" || !selectedMood) {
              quotesToShow = [...ANIME_QUOTES]
                .sort(() => 0.5 - Math.random())
                .slice(0, 12);
            } else {
              quotesToShow = this.getQuoteForMood(selectedMood, 12);
            }
            if (quotesToShow.length === 0) {
              this.quoteSliderResults.innerHTML = `<p class="empty-list-message">No quotes found for this mood. Try 'Random Quotes' or check your Liked Quotes section above!</p>`;
              return;
            }
            quotesToShow.forEach((quote, index) => {
              const card = document.createElement("div");
              card.classList.add("quote-card");
              card.dataset.quoteText = quote.quote;

              // Check if quote is liked (handle both old string format and new object format)
              const isLiked = this.favoriteQuotes.some((fav) => {
                if (typeof fav === "string") {
                  return fav === quote.quote;
                }
                return fav.quote === quote.quote;
              });

              const likeButtonHTML = `<button class="like-btn ${
                isLiked ? "liked" : ""
              }" data-quote="${quote.quote}" title="${
                isLiked ? "Unlike" : "Like"
              } Quote">${isLiked ? "❤️" : "🤍"}</button>`;
              card.innerHTML =
                this.createQuoteCardHTML(quote, true) + likeButtonHTML;
              this.quoteSliderResults.appendChild(card);
              gsap.fromTo(
                card,
                { opacity: 0, y: 25, scale: 0.96 },
                {
                  opacity: 1,
                  y: 0,
                  scale: 1,
                  duration: 0.5,
                  delay: index * 0.06 + 0.1,
                  ease: "back.out(1.3)",
                }
              );
            });
          },
          toggleQuoteSliderMode() {
            this.quoteSliderMode =
              this.quoteSliderMode === "mood" ? "random" : "mood";
            this.quoteModeToggle.innerHTML =
              this.quoteSliderMode === "random"
                ? "🎲 Random Mode"
                : "🧘 Mood Mode";
            this.moodFilterSelect.disabled = this.quoteSliderMode === "random";
            if (this.quoteSliderMode === "random")
              this.moodFilterSelect.value = "";
            this.loadQuotesForSlider();
          },
          toggleTheme() {
            this.isDarkTheme = !this.isDarkTheme;
            this.applyTheme();
            this.saveData();
          },
          updateThemeToggleButton() {
            this.themeToggle.innerHTML = this.isDarkTheme
              ? "🌙 Dark Mode"
              : "☀️ Light Mode";
          },
          renderHistoryList() {
            if (!this.historyList) return;
            const searchTerm = this.historySearchTerm.value.toLowerCase();
            const moodFilter = this.historyMoodFilter.value;
            const dateFilter = this.historyDateFilter.value;
            let filteredHistory = this.moodHistory.filter((entry) => {
              // Handle both Firestore timestamp and ISO string formats
              let entryDateObj;
              if (entry.timestamp && entry.timestamp.toDate) {
                // Firestore timestamp
                entryDateObj = entry.timestamp.toDate();
              } else if (entry.timestampISO) {
                // ISO string fallback
                entryDateObj = new Date(entry.timestampISO);
              } else if (entry.timestamp) {
                // Regular timestamp
                entryDateObj = new Date(entry.timestamp);
              } else {
                entryDateObj = new Date();
              }

              const entryDate = entryDateObj.toISOString().split("T")[0];
              const quote = entry.quote || {};
              const matchesSearch =
                !searchTerm ||
                entry.mood.name.toLowerCase().includes(searchTerm) ||
                (entry.reason &&
                  entry.reason.toLowerCase().includes(searchTerm)) ||
                (quote.quote &&
                  quote.quote.toLowerCase().includes(searchTerm)) ||
                (quote.anime &&
                  quote.anime.toLowerCase().includes(searchTerm)) ||
                (quote.character &&
                  quote.character.toLowerCase().includes(searchTerm));
              const matchesMood = !moodFilter || entry.mood.name === moodFilter;
              const matchesDate = !dateFilter || entryDate === dateFilter;
              return matchesSearch && matchesMood && matchesDate;
            });

            filteredHistory.sort((a, b) => {
              // Handle both Firestore timestamp and ISO string formats for sorting
              let aTime, bTime;

              if (a.timestamp && a.timestamp.toDate) {
                aTime = a.timestamp.toDate().getTime();
              } else if (a.timestampISO) {
                aTime = new Date(a.timestampISO).getTime();
              } else {
                aTime = new Date(a.timestamp).getTime();
              }

              if (b.timestamp && b.timestamp.toDate) {
                bTime = b.timestamp.toDate().getTime();
              } else if (b.timestampISO) {
                bTime = new Date(b.timestampISO).getTime();
              } else {
                bTime = new Date(b.timestamp).getTime();
              }

              return bTime - aTime;
            });
            this.historyList.innerHTML = "";
            if (filteredHistory.length === 0) {
              this.historyList.innerHTML = `<p class="empty-list-message">No history entries match your filters. Try adjusting them or add new moods!</p>`;
              return;
            }

            // Limit initial rendering for better performance
            const maxInitialItems = 20;
            const itemsToRender = filteredHistory.slice(0, maxInitialItems);

            itemsToRender.forEach((entry, index) => {
              const itemDiv = document.createElement("div");
              itemDiv.classList.add("history-item");
              const quote = entry.quote || {};
              const quoteCardHTML = quote.quote
                ? `<div class="quote-card" data-quote-text="${
                    quote.quote
                  }">${this.createQuoteCardHTML(quote, true)}</div>`
                : '<p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 10px;">(No quote associated)</p>';
              // Handle timestamp display for both formats
              let displayDate;
              if (entry.timestamp && entry.timestamp.toDate) {
                displayDate = entry.timestamp.toDate().toLocaleString();
              } else if (entry.timestampISO) {
                displayDate = new Date(entry.timestampISO).toLocaleString();
              } else {
                displayDate = new Date(entry.timestamp).toLocaleString();
              }

              itemDiv.innerHTML = `
                <div class="history-item-header">
                  <h4>
                    <span class="item-mood-emoji">${entry.mood.emoji}</span>
                    <span class="item-mood-name" data-mood="${
                      entry.mood.name
                    }">${entry.mood.name}</span>
                    <span class="mood-tag" style="background: var(--accent-${
                      entry.mood.name.toLowerCase().includes("happy")
                        ? "orange"
                        : entry.mood.name.toLowerCase().includes("sad")
                        ? "blue"
                        : entry.mood.name.toLowerCase().includes("angry")
                        ? "pink"
                        : "purple"
                    }); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 8px;">${
                entry.mood.name
              }</span>
                  </h4>
                  <p class="item-date"><i class="fas fa-calendar-alt"></i> ${displayDate}</p>
                </div>
                ${
                  entry.reason
                    ? `<div class="item-reason-container"><p class="item-reason"><i class="fas fa-comment"></i> <strong>Reflection:</strong> ${entry.reason}</p></div>`
                    : ""
                }
                ${quoteCardHTML}
              `;
              this.historyList.appendChild(itemDiv);
              // Simplified animation for better performance
              gsap.fromTo(
                itemDiv,
                { opacity: 0, y: 10 },
                {
                  opacity: 1,
                  y: 0,
                  duration: 0.3,
                  delay: index * 0.03,
                  ease: "power1.out",
                }
              );
            });
          },
          handleHistoryListClick(event) {
            const quoteCard = event.target.closest(
              ".quote-card[data-quote-text]"
            );
            if (quoteCard) {
              const quoteText = quoteCard.dataset.quoteText;
              const quote = ANIME_QUOTES.find((q) => q.quote === quoteText);
              if (quote) {
                this.openQuoteViewModal(quote);
              }
            }
          },
          handleQuoteCardClick(event) {
            const likeButton = event.target.closest(".like-btn");
            const clickedCard = event.target.closest(
              ".quote-card[data-quote-text]"
            );
            if (likeButton) {
              this.toggleFavoriteQuote(likeButton);
            } else if (clickedCard) {
              const quoteText = clickedCard.dataset.quoteText;
              const quote = ANIME_QUOTES.find((q) => q.quote === quoteText);
              if (quote) {
                this.openQuoteViewModal(quote);
              } else {
                console.warn("Quote data not found:", quoteText);
              }
            }
          },
          async toggleFavoriteQuote(button) {
            const quoteText = button.dataset.quote;
            if (!quoteText || !currentUser) return;

            const quote = ANIME_QUOTES.find((q) => q.quote === quoteText);
            if (!quote) return;

            const isCurrentlyFavorited = this.favoriteQuotes.some(
              (fav) => fav.quote === quoteText
            );

            try {
              if (isCurrentlyFavorited) {
                // Remove from favorites
                const likedQuotesQuery = query(
                  collection(this.db, "users", currentUser.uid, "likedQuotes"),
                  where("quote", "==", quoteText)
                );
                const querySnapshot = await getDocs(likedQuotesQuery);

                querySnapshot.forEach(async (docSnapshot) => {
                  await deleteDoc(docSnapshot.ref);
                });

                gsap.fromTo(
                  button,
                  { scale: 1.3 },
                  { scale: 1, duration: 0.3, ease: "back.out(1.7)" }
                );
              } else {
                // Add to favorites
                const likedQuoteData = {
                  quote: quote.quote,
                  character: quote.character || "",
                  anime: quote.anime || "",
                  likedAt: serverTimestamp(),
                };

                await addDoc(
                  collection(this.db, "users", currentUser.uid, "likedQuotes"),
                  likedQuoteData
                );

                gsap.fromTo(
                  button,
                  { scale: 0.5, opacity: 0.5 },
                  {
                    scale: 1,
                    opacity: 1,
                    duration: 0.5,
                    ease: "elastic.out(1, 0.6)",
                  }
                );
              }
            } catch (error) {
              console.error("Error toggling favorite in Firestore:", error);
            }
          },
          openQuoteViewModal(quote) {
            if (!quote) return;
            const detailsHTML = ` <p class="quote-view-quote">${
              quote.quote
            }</p> <p class="quote-view-source">- ${
              quote.character || "Unknown"
            }, ${
              quote.anime || "Unknown Source"
            }</p> <hr class="quote-view-separator"> <div class="quote-view-meta"> ${
              quote.anime
                ? `<div class="quote-view-meta-item"><strong>Anime:</strong> ${quote.anime}</div>`
                : ""
            } ${
              quote.character
                ? `<div class="quote-view-meta-item"><strong>Character:</strong> ${quote.character}</div>`
                : ""
            } ${
              quote.situation
                ? `<div class="quote-view-meta-item"><strong>Situation:</strong> ${quote.situation}</div>`
                : ""
            } ${
              quote.realLifeUse
                ? `<div class="quote-view-meta-item"><strong>Real-life use:</strong> ${quote.realLifeUse}</div>`
                : ""
            } </div> `;
            this.quoteViewDetails.innerHTML = detailsHTML;
            this.quoteViewModal.style.display = "flex";
            gsap.to(this.quoteViewModal, {
              opacity: 1,
              duration: 0.35,
              ease: "power1.inOut",
            });
            gsap.fromTo(
              this.quoteViewContent,
              { scale: 0.8, opacity: 0, y: 30 },
              {
                scale: 1,
                opacity: 1,
                y: 0,
                duration: 0.55,
                ease: "back.out(1.4)",
                delay: 0.1,
              }
            );
            this.quoteViewDetails.scrollTop = 0;
          },
          closeQuoteViewModal() {
            gsap.to(this.quoteViewContent, {
              scale: 0.85,
              opacity: 0,
              y: 40,
              duration: 0.4,
              ease: "power2.in",
              onComplete: () => {
                if (this.quoteViewModal)
                  this.quoteViewModal.style.display = "none";
                if (this.quoteViewDetails) this.quoteViewDetails.innerHTML = "";
              },
            });
            gsap.to(this.quoteViewModal, {
              opacity: 0,
              duration: 0.3,
              delay: 0.1,
            });
          },
          openInfoModal() {
            if (!this.infoModal || !this.infoModalContentElement) return;
            this.infoModal.style.display = "flex";

            // Setup language toggle functionality
            this.setupLanguageToggle();

            gsap.to(this.infoModal, {
              opacity: 1,
              duration: 0.35,
              ease: "power1.inOut",
            });
            gsap.fromTo(
              this.infoModalContentElement,
              { scale: 0.8, opacity: 0, y: 30 },
              {
                scale: 1,
                opacity: 1,
                y: 0,
                duration: 0.55,
                ease: "back.out(1.4)",
                delay: 0.1,
              }
            );
          },
          closeInfoModal() {
            if (!this.infoModal || !this.infoModalContentElement) return;
            gsap.to(this.infoModalContentElement, {
              scale: 0.85,
              opacity: 0,
              y: 40,
              duration: 0.4,
              ease: "power2.in",
              onComplete: () => {
                if (this.infoModal) this.infoModal.style.display = "none";
              },
            });
            gsap.to(this.infoModal, { opacity: 0, duration: 0.3, delay: 0.1 });
          },

          setupLanguageToggle() {
            const toggleBtn = document.getElementById("language-toggle-btn");
            const englishContent = document.getElementById("english-content");
            const hinglishContent = document.getElementById("hinglish-content");

            if (toggleBtn && englishContent && hinglishContent) {
              // Remove any existing event listeners
              const newToggleBtn = toggleBtn.cloneNode(true);
              toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);

              let isHinglish = false;

              newToggleBtn.addEventListener("click", () => {
                if (isHinglish) {
                  // Switch to English
                  englishContent.style.display = "block";
                  hinglishContent.style.display = "none";
                  newToggleBtn.innerHTML =
                    '<i class="fas fa-globe"></i> Switch to Hinglish';
                  newToggleBtn.style.background = "var(--accent-purple)";
                  isHinglish = false;
                } else {
                  // Switch to Hinglish
                  englishContent.style.display = "none";
                  hinglishContent.style.display = "block";
                  newToggleBtn.innerHTML =
                    '<i class="fas fa-globe"></i> Switch to English';
                  newToggleBtn.style.background = "var(--accent-orange)";
                  isHinglish = true;
                }

                // Add smooth transition effect
                gsap.fromTo(
                  isHinglish ? hinglishContent : englishContent,
                  { opacity: 0, y: 10 },
                  { opacity: 1, y: 0, duration: 0.3, ease: "power2.out" }
                );
              });
            }
          },

          // Analytics enhancement functions
          updateAnalyticsStats() {
            const totalEntriesEl =
              document.getElementById("total-entries-stat");
            const currentStreakEl = document.getElementById(
              "current-streak-stat"
            );
            const bestStreakEl = document.getElementById("best-streak-stat");
            const mostCommonMoodEl = document.getElementById(
              "most-common-mood-stat"
            );

            if (totalEntriesEl) {
              totalEntriesEl.textContent = this.moodHistory.length;
            }

            if (currentStreakEl) {
              currentStreakEl.textContent = this.currentStreak;
            }

            if (bestStreakEl) {
              bestStreakEl.textContent = this.highestStreak;
            }

            if (mostCommonMoodEl && this.moodHistory.length > 0) {
              const moodCounts = {};
              this.moodHistory.forEach((entry) => {
                const moodName = entry.mood.name;
                moodCounts[moodName] = (moodCounts[moodName] || 0) + 1;
              });

              const mostCommon = Object.entries(moodCounts).sort(
                ([, a], [, b]) => b - a
              )[0];

              if (mostCommon) {
                const moodEmoji =
                  this.moodHistory.find(
                    (entry) => entry.mood.name === mostCommon[0]
                  )?.mood.emoji || "😊";
                mostCommonMoodEl.innerHTML = `${moodEmoji} ${mostCommon[0]}`;
              }
            }
          },

          updateMoodInsights() {
            const journeyInsight = document.getElementById(
              "mood-journey-insight"
            );
            const weeklyInsight = document.getElementById(
              "weekly-summary-insight"
            );
            const recommendationsInsight = document.getElementById(
              "recommendations-insight"
            );

            if (!this.moodHistory.length) return;

            // Journey insight
            if (journeyInsight) {
              const totalDays = this.moodHistory.length;
              const uniqueMoods = new Set(
                this.moodHistory.map((entry) => entry.mood.name)
              ).size;
              const avgMoodsPerWeek = Math.round((totalDays / 7) * 10) / 10;

              journeyInsight.textContent = `You've logged ${totalDays} mood entries across ${uniqueMoods} different emotions. You're averaging ${avgMoodsPerWeek} entries per week - great consistency!`;
            }

            // Weekly summary
            if (weeklyInsight) {
              const now = new Date();
              const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

              const thisWeekEntries = this.moodHistory.filter((entry) => {
                let entryDate;
                if (entry.timestamp && entry.timestamp.toDate) {
                  entryDate = entry.timestamp.toDate();
                } else if (entry.timestampISO) {
                  entryDate = new Date(entry.timestampISO);
                } else {
                  entryDate = new Date(entry.timestamp);
                }
                return entryDate >= weekAgo;
              });

              if (thisWeekEntries.length > 0) {
                const weeklyMoodCounts = {};
                thisWeekEntries.forEach((entry) => {
                  const moodName = entry.mood.name;
                  weeklyMoodCounts[moodName] =
                    (weeklyMoodCounts[moodName] || 0) + 1;
                });

                const topWeeklyMood = Object.entries(weeklyMoodCounts).sort(
                  ([, a], [, b]) => b - a
                )[0];

                weeklyInsight.textContent = `This week you've logged ${thisWeekEntries.length} entries. Your most frequent mood was "${topWeeklyMood[0]}" (${topWeeklyMood[1]} times).`;
              } else {
                weeklyInsight.textContent =
                  "No entries this week yet. Try logging your mood today!";
              }
            }

            // Recommendations
            if (recommendationsInsight) {
              const moodCounts = {};
              this.moodHistory.forEach((entry) => {
                const moodName = entry.mood.name;
                moodCounts[moodName] = (moodCounts[moodName] || 0) + 1;
              });

              const sortedMoods = Object.entries(moodCounts).sort(
                ([, a], [, b]) => b - a
              );
              const topMood = sortedMoods[0];

              if (this.currentStreak >= 7) {
                recommendationsInsight.textContent = `Amazing! You're on a ${this.currentStreak}-day streak! Keep up the great work with daily mood tracking.`;
              } else if (
                topMood &&
                topMood[0].toLowerCase().includes("happy")
              ) {
                recommendationsInsight.textContent =
                  "You seem to experience happiness frequently! Consider exploring what activities or situations contribute to these positive feelings.";
              } else if (
                topMood &&
                (topMood[0].toLowerCase().includes("sad") ||
                  topMood[0].toLowerCase().includes("down"))
              ) {
                recommendationsInsight.textContent =
                  "If you're experiencing frequent low moods, consider talking to someone you trust or exploring activities that bring you joy.";
              } else {
                recommendationsInsight.textContent =
                  "Try to identify patterns in your mood changes. What activities, people, or situations influence your emotions the most?";
              }
            }
          },

          // Performance optimization functions
          togglePerformanceMode() {
            this.performanceMode = !this.performanceMode;
            const performanceToggle =
              document.getElementById("performance-toggle");

            if (performanceToggle) {
              if (this.performanceMode) {
                performanceToggle.innerHTML =
                  '<i class="fas fa-bolt"></i> Performance Mode: ON';
                performanceToggle.style.background =
                  "var(--accent-green, #10b981)";

                // Reduce background particles further
                if (p5Instance) {
                  // Clear existing particles
                  particles.length = 0;
                  emojiParticles.length = 0;

                  // Create minimal particles
                  for (let i = 0; i < 5; i++) {
                    particles.push(new Particle(p5Instance));
                  }
                  for (let i = 0; i < 3; i++) {
                    emojiParticles.push(new EmojiParticle(p5Instance));
                  }

                  // Lower frame rate
                  p5Instance.frameRate(20);
                }

                console.log(
                  "Performance mode enabled - reduced animations and particles"
                );
              } else {
                performanceToggle.innerHTML =
                  '<i class="fas fa-bolt"></i> Performance Mode: OFF';
                performanceToggle.style.background = "var(--accent-orange)";

                // Restore normal particles
                if (p5Instance) {
                  // Clear existing particles
                  particles.length = 0;
                  emojiParticles.length = 0;

                  // Create normal amount of particles
                  for (let i = 0; i < 15; i++) {
                    particles.push(new Particle(p5Instance));
                  }
                  for (let i = 0; i < 12; i++) {
                    emojiParticles.push(new EmojiParticle(p5Instance));
                  }

                  // Normal frame rate
                  p5Instance.frameRate(30);
                }

                console.log(
                  "Performance mode disabled - normal animations restored"
                );
              }
            }

            // Save preference to localStorage
            localStorage.setItem(
              "devMoodMirror_performanceMode",
              this.performanceMode.toString()
            );
          },

          // Public mood sharing toggle function
          async togglePublicMoodSharingUI() {
            const newState = !this.publicMoodSharingEnabled;
            await this.togglePublicMoodSharing(newState);
            this.updatePublicMoodSharingToggleUI();
          },

          updatePublicMoodSharingToggleUI() {
            const toggle = document.getElementById(
              "public-mood-sharing-toggle"
            );
            if (toggle) {
              if (this.publicMoodSharingEnabled) {
                toggle.innerHTML =
                  '<i class="fas fa-users"></i> Public Mood Sharing: ON';
                toggle.style.background = "var(--accent-green, #10b981)";
              } else {
                toggle.innerHTML =
                  '<i class="fas fa-users"></i> Public Mood Sharing: OFF';
                toggle.style.background = "var(--accent-purple)";
              }
            }
          },

          // Public Mood page functions
          loadPublicMoodPage() {
            this.setupPublicMoodEventListeners();
            this.renderPublicMoodFeed();
          },

          setupPublicMoodEventListeners() {
            // Toggle between public feed and my public moods
            if (this.publicFeedBtn) {
              this.publicFeedBtn.addEventListener("click", () => {
                this.switchPublicMoodView("feed");
              });
            }
            if (this.myPublicMoodsBtn) {
              this.myPublicMoodsBtn.addEventListener("click", () => {
                this.switchPublicMoodView("my-moods");
              });
            }
          },

          switchPublicMoodView(viewMode) {
            this.publicMoodViewMode = viewMode;

            // Update button states
            if (this.publicFeedBtn && this.myPublicMoodsBtn) {
              if (viewMode === "feed") {
                this.publicFeedBtn.classList.add("active");
                this.publicFeedBtn.style.background = "var(--accent-blue)";
                this.publicFeedBtn.style.color = "white";
                this.myPublicMoodsBtn.classList.remove("active");
                this.myPublicMoodsBtn.style.background = "transparent";
                this.myPublicMoodsBtn.style.color = "var(--text-secondary)";
              } else {
                this.myPublicMoodsBtn.classList.add("active");
                this.myPublicMoodsBtn.style.background = "var(--accent-blue)";
                this.myPublicMoodsBtn.style.color = "white";
                this.publicFeedBtn.classList.remove("active");
                this.publicFeedBtn.style.background = "transparent";
                this.publicFeedBtn.style.color = "var(--text-secondary)";
              }
            }

            // Show/hide containers
            if (this.publicMoodFeedContainer && this.myPublicMoodsContainer) {
              if (viewMode === "feed") {
                this.publicMoodFeedContainer.style.display = "block";
                this.myPublicMoodsContainer.style.display = "none";
              } else {
                this.publicMoodFeedContainer.style.display = "none";
                this.myPublicMoodsContainer.style.display = "block";
              }
            }

            this.renderPublicMoodFeed();
          },

          renderPublicMoodFeed() {
            const moodsToRender =
              this.publicMoodViewMode === "feed"
                ? this.publicMoods
                : this.myPublicMoods;

            const container =
              this.publicMoodViewMode === "feed"
                ? this.publicMoodFeedContainer
                : this.myPublicMoodsContainer;

            if (!container) return;

            // Show empty state if no moods
            if (moodsToRender.length === 0) {
              if (this.publicMoodEmptyState) {
                this.publicMoodEmptyState.style.display = "block";
              }
              container.innerHTML = "";
              return;
            }

            // Hide empty state
            if (this.publicMoodEmptyState) {
              this.publicMoodEmptyState.style.display = "none";
            }

            // Render mood cards
            container.innerHTML = "";
            moodsToRender.forEach((mood, index) => {
              const moodCard = this.createPublicMoodCard(mood);
              container.appendChild(moodCard);

              // Animate card appearance
              gsap.fromTo(
                moodCard,
                { opacity: 0, y: 20, scale: 0.95 },
                {
                  opacity: 1,
                  y: 0,
                  scale: 1,
                  duration: 0.4,
                  delay: index * 0.05,
                  ease: "back.out(1.2)",
                }
              );
            });
          },

          createPublicMoodCard(mood) {
            const card = document.createElement("div");
            card.className = "public-mood-card";
            card.style.cssText = `
              background: var(--bg-secondary);
              border-radius: 12px;
              padding: 1.5rem;
              margin-bottom: 1rem;
              border: 1px solid var(--border-color);
              transition: all 0.3s ease;
            `;

            const timeAgo = this.getTimeAgo(
              new Date(mood.timestampISO || mood.timestamp)
            );
            const isOwnMood = mood.userId === currentUser?.uid;

            card.innerHTML = `
              <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <div style="font-size: 2.5rem; flex-shrink: 0;">
                  ${mood.mood.emoji}
                </div>
                <div style="flex: 1; min-width: 0;">
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: var(--text-primary);">
                      ${isOwnMood ? "You" : mood.userDisplayName}
                    </span>
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">
                      feeling ${mood.mood.name}
                    </span>
                  </div>
                  ${
                    mood.reason
                      ? `
                    <p style="color: var(--text-primary); margin: 0.5rem 0; font-size: 0.95rem; line-height: 1.4;">
                      "${mood.reason}"
                    </p>
                  `
                      : ""
                  }
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1rem;">
                    <span style="color: var(--text-secondary); font-size: 0.85rem;">
                      <i class="fas fa-clock"></i> ${timeAgo}
                    </span>
                    ${
                      mood.quote && mood.quote.quote !== "No quote."
                        ? `
                      <button class="show-quote-btn" style="
                        background: none;
                        border: 1px solid var(--accent-purple);
                        color: var(--accent-purple);
                        padding: 0.25rem 0.75rem;
                        border-radius: 6px;
                        font-size: 0.8rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                      " onmouseover="this.style.background='var(--accent-purple)'; this.style.color='white';"
                         onmouseout="this.style.background='none'; this.style.color='var(--accent-purple)';">
                        <i class="fas fa-quote-left"></i> Quote
                      </button>
                    `
                        : ""
                    }
                  </div>
                </div>
              </div>
            `;

            // Add quote display functionality
            const quoteBtn = card.querySelector(".show-quote-btn");
            if (quoteBtn && mood.quote) {
              quoteBtn.addEventListener("click", () => {
                this.showPublicMoodQuote(mood.quote);
              });
            }

            return card;
          },

          getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 1) return "just now";
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
          },

          showPublicMoodQuote(quote) {
            // Create a simple modal to show the quote
            const modal = document.createElement("div");
            modal.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.5);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 1000;
              backdrop-filter: blur(4px);
            `;

            modal.innerHTML = `
              <div style="
                background: var(--bg-main);
                border-radius: 12px;
                padding: 2rem;
                max-width: 500px;
                margin: 1rem;
                border: 1px solid var(--border-color);
                position: relative;
              ">
                <button style="
                  position: absolute;
                  top: 1rem;
                  right: 1rem;
                  background: none;
                  border: none;
                  font-size: 1.5rem;
                  color: var(--text-secondary);
                  cursor: pointer;
                " onclick="this.closest('.quote-modal').remove();">
                  <i class="fas fa-times"></i>
                </button>
                <div style="margin-bottom: 1rem;">
                  <p style="font-size: 1.1rem; line-height: 1.6; color: var(--text-primary); margin-bottom: 1rem;">
                    "${quote.quote}"
                  </p>
                  <p style="color: var(--text-secondary); font-style: italic;">
                    - ${quote.character || "Unknown"}, ${
              quote.anime || "Unknown Source"
            }
                  </p>
                </div>
              </div>
            `;

            modal.className = "quote-modal";
            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                modal.remove();
              }
            });

            // Animate in
            gsap.fromTo(modal, { opacity: 0 }, { opacity: 1, duration: 0.3 });
            gsap.fromTo(
              modal.querySelector("div"),
              { scale: 0.8, opacity: 0 },
              {
                scale: 1,
                opacity: 1,
                duration: 0.4,
                delay: 0.1,
                ease: "back.out(1.3)",
              }
            );
          },

          // Profile page functions
          loadProfilePage() {
            if (!userProfile || !currentUser) return;

            // Update profile form fields
            const displayNameInput = document.getElementById(
              "profile-display-name"
            );
            const emailInput = document.getElementById("profile-email");
            const memberSinceInput = document.getElementById(
              "profile-member-since"
            );

            if (displayNameInput)
              displayNameInput.value = userProfile.displayName || "";
            if (emailInput) emailInput.value = userProfile.email || "";
            if (memberSinceInput) {
              const createdDate = userProfile.createdAt
                ? userProfile.createdAt.toDate
                  ? userProfile.createdAt.toDate()
                  : new Date(userProfile.createdAt)
                : new Date();
              memberSinceInput.value = createdDate.toLocaleDateString();
            }

            // Update statistics
            const currentStreakEl = document.getElementById(
              "profile-current-streak"
            );
            const highestStreakEl = document.getElementById(
              "profile-highest-streak"
            );
            const totalEntriesEl = document.getElementById(
              "profile-total-entries"
            );
            const lastEntryEl = document.getElementById("profile-last-entry");

            if (currentStreakEl)
              currentStreakEl.textContent = userProfile.currentStreak || 0;
            if (highestStreakEl)
              highestStreakEl.textContent = userProfile.highestStreak || 0;
            if (totalEntriesEl)
              totalEntriesEl.textContent = userProfile.totalMoodEntries || 0;
            if (lastEntryEl) {
              if (userProfile.lastMoodDate) {
                const lastDate = userProfile.lastMoodDate.toDate
                  ? userProfile.lastMoodDate.toDate()
                  : new Date(userProfile.lastMoodDate);
                lastEntryEl.textContent = lastDate.toLocaleDateString();
              } else {
                lastEntryEl.textContent = "Never";
              }
            }
          },

          async updateDisplayName() {
            const displayNameInput = document.getElementById(
              "profile-display-name"
            );
            const updateBtn = document.getElementById(
              "update-display-name-btn"
            );

            if (!displayNameInput || !currentUser) return;

            const newDisplayName = displayNameInput.value.trim();
            if (!newDisplayName) {
              alert("Please enter a valid display name.");
              return;
            }

            try {
              updateBtn.disabled = true;
              updateBtn.textContent = "Updating...";

              // Update Firebase Auth profile
              await updateProfile(currentUser, {
                displayName: newDisplayName,
              });

              // Update Firestore user document
              await updateDoc(doc(this.db, "users", currentUser.uid), {
                displayName: newDisplayName,
              });

              // Update local userProfile
              userProfile.displayName = newDisplayName;

              // Update header display
              updateHeaderWithUserInfo();

              updateBtn.textContent = "Updated!";
              setTimeout(() => {
                updateBtn.textContent = "Update";
                updateBtn.disabled = false;
              }, 2000);
            } catch (error) {
              console.error("Error updating display name:", error);
              alert("Failed to update display name. Please try again.");
              updateBtn.textContent = "Update";
              updateBtn.disabled = false;
            }
          },

          async deleteAccount() {
            if (!currentUser) return;

            const confirmation = confirm(
              "Are you sure you want to delete your account? This action cannot be undone and will permanently delete all your mood data, quotes, and account information."
            );

            if (!confirmation) return;

            const finalConfirmation = prompt(
              'To confirm account deletion, please type "DELETE" (in capital letters):'
            );

            if (finalConfirmation !== "DELETE") {
              alert("Account deletion cancelled.");
              return;
            }

            try {
              // Delete user data from Firestore
              // Note: In a production app, you'd want to use Cloud Functions for this
              // to ensure all subcollections are properly deleted

              // Delete user document (this won't delete subcollections in client-side code)
              await deleteDoc(doc(this.db, "users", currentUser.uid));

              // Delete the user account
              await currentUser.delete();

              alert("Your account has been successfully deleted.");

              // Redirect to landing page
              window.location.href = "landingpage.html";
            } catch (error) {
              console.error("Error deleting account:", error);
              if (error.code === "auth/requires-recent-login") {
                alert(
                  "For security reasons, please log out and log back in before deleting your account."
                );
              } else {
                alert(
                  "Failed to delete account. Please try again or contact support."
                );
              }
            }
          },
        }; // End app object

        // Initialize app only if user is already authenticated
        // Otherwise, it will be initialized by the auth state observer
        if (currentUser) {
          app
            .init()
            .catch((err) => console.error("App initialization failed:", err));
        }

        window.DevMoodMirrorApp = app; // For debugging
        window.app = app; // Make globally accessible

        // Global function for testing streak functionality from browser console
        window.testStreak = function () {
          if (window.app) {
            window.app.testStreakLogic();
          } else {
            console.log("App not initialized yet");
          }
        };
      }); // End DOMContentLoaded
    </script>
  </body>
</html>
